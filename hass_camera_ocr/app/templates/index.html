<!DOCTYPE html>
<html lang="en">
<head>
    <title>Camera OCR</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --primary: #03a9f4;
            --primary-dark: #0288d1;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --bg-1: #0d1117;
            --bg-2: #161b22;
            --bg-3: #21262d;
            --bg-4: #30363d;
            --border: #30363d;
            --text-1: #f0f6fc;
            --text-2: #8b949e;
            --text-3: #6e7681;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-1);
            color: var(--text-1);
            min-height: 100vh;
        }

        /* Layout */
        .app { display: flex; flex-direction: column; min-height: 100vh; }

        .header {
            background: var(--bg-2);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .logo svg { width: 24px; height: 24px; color: var(--primary); }

        .nav {
            display: flex;
            gap: 4px;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-2);
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .nav-btn:hover { background: var(--bg-3); color: var(--text-1); }
        .nav-btn.active { background: var(--primary); color: white; }

        .main { flex: 1; padding: 20px; max-width: 1600px; margin: 0 auto; width: 100%; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.2s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Cards */
        .card {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid */
        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }

        /* Dashboard Cards */
        .value-card {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .value-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .value-card-name { font-size: 14px; color: var(--text-2); font-weight: 500; }
        .value-card-status { font-size: 11px; padding: 2px 8px; border-radius: 10px; }
        .value-card-status.ok { background: rgba(76, 175, 80, 0.2); color: var(--success); }
        .value-card-status.error { background: rgba(244, 67, 54, 0.2); color: var(--error); }
        .value-card-status.pending { background: rgba(255, 193, 7, 0.2); color: #ffc107; }

        .value-card-value {
            font-size: 42px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }

        .value-card-unit { font-size: 18px; color: var(--text-2); margin-left: 4px; }
        .value-card-meta { font-size: 12px; color: var(--text-3); }
        .value-card-description {
            font-size: 12px;
            color: var(--text-2);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-style: italic;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg-3); color: var(--text-1); }
        .btn-secondary:hover { background: var(--bg-4); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-icon { padding: 8px; }

        .btn svg { width: 16px; height: 16px; }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text-2); }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-3);
            color: var(--text-1);
            font-size: 14px;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-check input { width: 16px; height: 16px; }

        /* URL Mode Toggle */
        .url-mode-toggle {
            display: flex;
            gap: 0;
            margin-top: 8px;
        }
        .url-mode-btn {
            flex: 1;
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .url-mode-btn:first-child {
            border-radius: 6px 0 0 6px;
        }
        .url-mode-btn:last-child {
            border-radius: 0 6px 6px 0;
            border-left: none;
        }
        .url-mode-btn:hover {
            background: var(--bg);
        }
        .url-mode-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .form-hint {
            display: block;
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Multi-Provider List */
        .provider-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }
        .provider-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-3);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: grab;
        }
        .provider-item:active { cursor: grabbing; }
        .provider-item.dragging { opacity: 0.5; }
        .provider-item .drag-handle {
            color: var(--text-3);
            cursor: grab;
        }
        .provider-item .provider-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }
        .provider-item .provider-status {
            font-size: 12px;
            color: var(--text-3);
        }
        .provider-item .provider-status.configured { color: var(--success); }
        .provider-item .provider-status.needs-config { color: var(--warning); }
        .provider-item .provider-actions {
            display: flex;
            gap: 4px;
        }
        .provider-item .provider-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-2);
        }
        .provider-item .provider-btn:hover { background: var(--border); }
        .provider-item .provider-btn.remove { color: var(--error); }
        .add-provider-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            border: 2px dashed var(--border);
            border-radius: 6px;
            background: transparent;
            color: var(--text-3);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .add-provider-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .provider-config-panel {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
        }
        .provider-config-panel .panel-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .provider-results-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        .provider-result-item {
            padding: 8px 12px;
            background: var(--bg-3);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .provider-result-item .result-provider {
            font-size: 12px;
            font-weight: 500;
        }
        .provider-result-item .result-value {
            font-size: 14px;
            font-weight: 600;
        }
        .provider-result-item .result-confidence {
            font-size: 11px;
            color: var(--text-3);
        }
        .provider-result-item.selected {
            border: 1px solid var(--success);
            background: rgba(76, 175, 80, 0.1);
        }
        .ml-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .ml-status-badge.available { background: rgba(76, 175, 80, 0.2); color: var(--success); }
        .ml-status-badge.unavailable { background: rgba(244, 67, 54, 0.2); color: var(--error); }
        .url-preview {
            background: var(--bg);
            border-radius: 6px;
            padding: 12px;
            border: 1px solid var(--border);
        }
        .url-preview-text {
            font-family: monospace;
            font-size: 12px;
            color: var(--primary);
            word-break: break-all;
        }

        /* Preview Container */
        .preview-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            min-height: 500px;
        }

        .preview-main {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        @media (max-width: 1000px) {
            .preview-container { grid-template-columns: 1fr; }
        }

        .preview-frame {
            background: var(--bg-3);
            border-radius: 8px;
            overflow: auto;
            position: relative;
            aspect-ratio: 16 / 9;
            max-height: 70vh;
            flex-shrink: 0;
        }

        .preview-wrapper {
            position: relative;
            display: inline-block;
            transform-origin: top left;
        }

        .preview-frame img {
            display: block;
            max-width: none;
        }

        .preview-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        .saved-rois-section {
            margin-top: 12px;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
        }

        .saved-rois-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 500;
            color: var(--text-2);
        }

        .saved-rois-list {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .saved-roi-item {
            position: relative;
            width: 120px;
            background: var(--bg);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .saved-roi-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            display: block;
        }

        .saved-roi-info {
            padding: 6px;
            font-size: 11px;
        }

        .saved-roi-value {
            font-weight: 600;
            color: var(--primary);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
        }

        .saved-roi-value .validated-value {
            color: var(--success);
            font-size: 12px;
            background: rgba(76, 175, 80, 0.15);
            padding: 1px 4px;
            border-radius: 3px;
        }

        .saved-roi-time {
            color: var(--text-3);
            margin-top: 2px;
        }

        .saved-roi-item.validated {
            border-color: var(--success);
        }

        .saved-roi-item.processing {
            animation: pulse-border 1s ease-in-out infinite;
        }

        @keyframes pulse-border {
            0%, 100% {
                box-shadow: 0 0 4px var(--primary-alpha);
            }
            50% {
                box-shadow: 0 0 12px var(--primary);
            }
        }

        .validated-badge {
            position: absolute;
            top: 4px;
            left: 4px;
            background: var(--success);
            color: #fff;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            z-index: 2;
        }

        .saved-roi-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border: none;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .saved-roi-item:hover .saved-roi-delete {
            opacity: 1;
        }

        .saved-roi-delete:hover {
            background: var(--error);
        }

        .saved-roi-buttons {
            position: absolute;
            top: 4px;
            left: 4px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .saved-roi-item:hover .saved-roi-buttons {
            opacity: 1;
        }

        .saved-roi-apply, .saved-roi-test {
            width: 24px;
            height: 24px;
            padding: 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .saved-roi-apply {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        .saved-roi-test {
            background: rgba(33, 150, 243, 0.9);
            color: white;
        }

        .saved-roi-apply:hover {
            background: var(--success);
        }

        .saved-roi-test:hover {
            background: var(--primary);
        }

        .mode-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg);
            padding: 4px;
            border-radius: 6px;
        }

        .mode-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            background: var(--border);
            color: var(--text);
        }

        .mode-btn.active {
            background: var(--primary);
            color: #fff;
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 4px;
            z-index: 10;
            background: rgba(0,0,0,0.7);
            border-radius: 6px;
            padding: 4px;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--card-bg);
            color: var(--text);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }

        .zoom-btn:hover {
            background: var(--primary);
            color: white;
        }

        .ptz-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            margin-left: 8px;
            padding-left: 8px;
            border-left: 1px solid rgba(255,255,255,0.2);
        }

        .ptz-row {
            display: flex;
            gap: 2px;
        }

        .ptz-btn {
            width: 28px;
            height: 28px;
            font-size: 14px;
        }

        .ptz-home {
            font-size: 16px;
        }

        .zoom-level {
            color: white;
            font-size: 12px;
            padding: 0 8px;
            display: flex;
            align-items: center;
        }

        .preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-3);
        }

        .preview-placeholder svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }

        .preview-sidebar { display: flex; flex-direction: column; gap: 16px; }

        /* ROI Display */
        .roi-display {
            background: var(--bg-3);
            border-radius: 6px;
            padding: 12px;
        }

        .roi-values {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .roi-value {
            background: var(--bg-2);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .roi-value-label { font-size: 11px; color: var(--text-3); text-transform: uppercase; }
        .roi-value-num { font-size: 18px; font-weight: 600; font-family: monospace; }

        /* Result Display */
        .result-display {
            background: var(--bg-3);
            border-radius: 6px;
            padding: 16px;
            text-align: center;
        }

        .result-value { font-size: 48px; font-weight: 700; color: var(--success); }
        .result-raw { font-size: 13px; color: var(--text-3); margin-top: 8px; }
        .result-confidence { font-size: 12px; color: var(--text-2); margin-top: 4px; }

        /* Camera List */
        .camera-item {
            background: var(--bg-3);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .camera-item-preview {
            width: 120px;
            height: 80px;
            background: var(--bg-2);
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .camera-item-preview img { width: 100%; height: 100%; object-fit: cover; }

        .camera-item-info { flex: 1; min-width: 0; }
        .camera-item-name { font-weight: 600; margin-bottom: 4px; }
        .camera-item-url { font-size: 13px; color: var(--text-3); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .camera-item-actions { display: flex; gap: 8px; }

        /* Discovery */
        .discovery-item {
            background: var(--bg-3);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .discovery-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .discovery-item-info h4 { font-size: 15px; margin-bottom: 4px; }
        .discovery-item-info p { font-size: 13px; color: var(--text-3); }
        .discovery-item-preview {
            width: 100%;
            aspect-ratio: 16/9;
            background: var(--bg);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .discovery-item-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .discovery-item-preview .preview-placeholder {
            color: var(--text-3);
            font-size: 12px;
            text-align: center;
            height: auto;
            padding: 20px;
        }
        .discovery-item-preview .preview-placeholder svg {
            width: 48px;
            height: 48px;
            margin-bottom: 8px;
            opacity: 0.4;
        }
        .discovery-item-preview .preview-error {
            color: var(--text-3);
            font-size: 11px;
            text-align: center;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .discovery-item-preview .preview-error svg {
            width: 40px;
            height: 40px;
            opacity: 0.3;
        }
        .discovery-item-preview .preview-error small {
            opacity: 0.7;
        }
        .discovery-item-actions {
            display: flex;
            gap: 8px;
            width: 100%;
        }
        .discovery-item-actions .btn {
            flex: 1;
        }

        /* Template List */
        .template-item {
            background: var(--bg-3);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .template-preview {
            width: 80px;
            height: 60px;
            background: var(--bg-2);
            border-radius: 4px;
            overflow: hidden;
        }

        .template-preview img { width: 100%; height: 100%; object-fit: contain; }
        .template-info { flex: 1; }
        .template-name { font-weight: 500; margin-bottom: 2px; }
        .template-meta { font-size: 12px; color: var(--text-3); }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-2); cursor: pointer; padding: 4px; }
        .modal-close:hover { color: var(--text-1); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: var(--bg-3);
            border: 1px solid var(--border);
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.2s;
            min-width: 250px;
        }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.info { border-left: 3px solid var(--primary); }

        /* Live indicator */
        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .live-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--error);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .live-badge.paused {
            background: rgba(128, 128, 128, 0.2);
            color: var(--text-secondary);
        }
        .live-badge.paused::before {
            background: var(--text-secondary);
            animation: none;
        }
        .live-controls {
            display: inline-flex;
            margin-left: 8px;
            gap: 4px;
        }
        .live-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .live-btn:hover {
            background: var(--bg-2);
            color: var(--text);
        }

        /* History table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .history-table th, .history-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .history-table th {
            background: var(--bg);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
        }
        .history-table tr:hover {
            background: var(--bg);
        }
        .history-table td.value-cell {
            font-weight: 600;
            color: var(--primary);
            text-align: right;
        }
        .history-table td.value-cell span {
            font-weight: 600;
        }
        .history-table th.value-header {
            text-align: right;
        }
        .history-table .order-cell,
        .history-table th.order-header {
            width: 40px;
            text-align: center;
            color: var(--text-secondary);
        }
        .history-table .error-cell {
            color: var(--error);
        }
        .low-confidence {
            color: var(--error) !important;
        }
        .low-confidence-text {
            font-size: 11px;
            color: var(--error);
            opacity: 0.8;
        }
        .confidence-bar {
            width: 80px;
            height: 8px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
        }
        .confidence-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .confidence-bar-fill.high { background: var(--success); }
        .confidence-bar-fill.medium { background: var(--warning, #f59e0b); }
        .confidence-bar-fill.low { background: var(--error); }
        .confidence-text {
            display: inline-block;
            width: 35px;
            text-align: right;
            margin-right: 8px;
            font-size: 12px;
        }
        .history-thumbnail {
            width: 50px;
            height: 35px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .history-thumbnail:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .history-thumbnail-placeholder {
            width: 50px;
            height: 35px;
            background: var(--bg);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-3);
            font-size: 10px;
        }
        .history-detail-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 20px;
        }
        .history-detail-content {
            background: var(--card-bg);
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--primary);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .history-detail-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-detail-header h3 {
            margin: 0;
            font-size: 16px;
        }
        .history-detail-body {
            padding: 20px;
        }
        .history-detail-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            background: var(--bg);
            margin-bottom: 16px;
        }
        .history-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .history-detail-item {
            background: var(--bg);
            padding: 12px;
            border-radius: 6px;
        }
        .history-detail-item label {
            font-size: 11px;
            color: var(--text-3);
            text-transform: uppercase;
            display: block;
            margin-bottom: 4px;
        }
        .history-detail-item .value {
            font-size: 15px;
            font-weight: 600;
        }
        .history-detail-item.full-width {
            grid-column: 1 / -1;
        }
        .history-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .history-tab {
            padding: 6px 14px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .history-tab:hover {
            background: var(--bg);
        }
        .history-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-3);
        }

        .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 18px; color: var(--text-2); margin-bottom: 8px; }
        .empty-state p { font-size: 14px; margin-bottom: 20px; }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--bg-4);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Status bar */
        .status-bar {
            background: var(--bg-2);
            border-top: 1px solid var(--border);
            padding: 8px 20px;
            font-size: 12px;
            color: var(--text-3);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-item { display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--error); }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                </svg>
                Camera OCR
                <span style="font-size: 11px; color: var(--text-3); font-weight: 400; margin-left: 8px;">v{{ version }}</span>
            </div>
            <nav class="nav">
                <button class="nav-btn active" data-page="dashboard">Dashboard</button>
                <button class="nav-btn" data-page="cameras">Cameras</button>
                <button class="nav-btn" data-page="live">Live Preview</button>
                <button class="nav-btn" data-page="templates">Templates</button>
                <button class="nav-btn" data-page="discover">Discover</button>
            </nav>
        </header>

        <main class="main">
            <!-- Dashboard Page -->
            <div id="page-dashboard" class="page active">
                <div class="card">
                    <div class="card-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Extracted Values
                        <span class="live-badge" id="live-badge">LIVE</span>
                        <div class="live-controls">
                            <button class="live-btn" id="pause-btn" onclick="toggleLiveUpdates()" title="Pause updates">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                                    <rect x="6" y="4" width="4" height="16"></rect>
                                    <rect x="14" y="4" width="4" height="16"></rect>
                                </svg>
                            </button>
                            <button class="live-btn" id="resume-btn" onclick="toggleLiveUpdates()" title="Resume updates" style="display: none;">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                                    <polygon points="5,3 19,12 5,21"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="values-grid" class="grid grid-3">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                            <h3>No cameras configured</h3>
                            <p>Add cameras to start extracting values</p>
                            <button class="btn btn-primary" onclick="showPage('cameras')">Add Camera</button>
                        </div>
                    </div>
                </div>

                <!-- Value History Section -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title" style="justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg>
                            Value History (Last 20 readings)
                        </div>
                        <button class="btn btn-sm" onclick="clearHistory()" style="background: var(--error);" title="Clear all history">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Clear
                        </button>
                    </div>
                    <div id="history-container">
                        <p style="color: var(--text-3);">No history available yet</p>
                    </div>
                </div>
            </div>

            <!-- Cameras Page -->
            <div id="page-cameras" class="page">
                <div class="card">
                    <div class="card-title" style="justify-content: space-between;">
                        <span>Configured Cameras</span>
                        <button class="btn btn-primary" onclick="openAddCameraModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Camera
                        </button>
                    </div>
                    <div id="cameras-list" class="grid"></div>
                </div>
            </div>

            <!-- Live Preview Page -->
            <div id="page-live" class="page">
                <div class="card">
                    <div class="card-title" style="justify-content: space-between;">
                        <span>Live Preview & ROI Selection</span>
                        <div class="mode-toggle">
                            <button class="mode-btn active" id="mode-edit-btn" onclick="setPreviewMode('edit')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                EDIT
                            </button>
                            <button class="mode-btn" id="mode-test-btn" onclick="setPreviewMode('test')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                TEST
                            </button>
                        </div>
                    </div>
                    <div class="form-row" style="margin-bottom: 16px;">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Select Camera</label>
                            <select id="live-camera-select" class="form-select" onchange="loadLivePreview()">
                                <option value="">-- Select a camera --</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Preprocessing</label>
                            <select id="live-preprocessing" class="form-select">
                                <option value="auto">Auto</option>
                                <option value="none">None</option>
                                <option value="threshold">Threshold</option>
                                <option value="adaptive">Adaptive</option>
                                <option value="invert">Invert</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end; gap: 8px;">
                            <button class="btn btn-primary" onclick="refreshLivePreview()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                </svg>
                                Refresh
                            </button>
                            <button class="btn btn-secondary" onclick="editSelectedCamera()" title="Edit camera settings">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Edit
                            </button>
                        </div>
                    </div>

                    <div class="preview-container">
                        <div class="preview-main">
                            <div class="preview-frame" id="preview-frame">
                                <div class="preview-placeholder" id="preview-placeholder">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                        <circle cx="12" cy="13" r="4"></circle>
                                    </svg>
                                    <p>Select a camera and click Refresh to load preview</p>
                                </div>
                                <div class="zoom-controls" id="zoom-controls" style="display: none;">
                                    <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">−</button>
                                    <span class="zoom-level" id="zoom-level">100%</span>
                                    <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
                                    <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">⟲</button>
                                    <div class="ptz-controls">
                                        <button class="zoom-btn ptz-btn" onclick="ptzMove('up')" title="Tilt Up">▲</button>
                                        <div class="ptz-row">
                                            <button class="zoom-btn ptz-btn" onclick="ptzMove('left')" title="Pan Left">◄</button>
                                            <button class="zoom-btn ptz-btn ptz-home" onclick="ptzMove('home')" title="Home">⌂</button>
                                            <button class="zoom-btn ptz-btn" onclick="ptzMove('right')" title="Pan Right">►</button>
                                        </div>
                                        <button class="zoom-btn ptz-btn" onclick="ptzMove('down')" title="Tilt Down">▼</button>
                                    </div>
                                </div>
                                <div class="preview-wrapper" id="preview-wrapper">
                                    <img id="preview-image" style="display: none;" />
                                    <canvas id="preview-canvas" class="preview-canvas" style="display: none;"></canvas>
                                </div>
                            </div>

                            <!-- Saved ROIs Section - Outside scrollable area -->
                            <div class="saved-rois-section" id="saved-rois-section" style="display: none;">
                                <div class="saved-rois-header">
                                    <span>Saved ROIs</span>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-sm" onclick="trainOCR()" id="train-ocr-btn" style="background: var(--warning); color: #000;" title="Train OCR using validated ROIs">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="margin-right: 4px;">
                                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                                            </svg>
                                            Train OCR
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="testAllROIs()" id="test-all-btn">Test All</button>
                                        <button class="btn btn-success btn-sm" onclick="saveCurrentROI()">Save ROI</button>
                                    </div>
                                </div>
                                <div class="saved-rois-list" id="saved-rois-list"></div>
                            </div>
                        </div>

                        <div class="preview-sidebar">
                            <div class="card" style="margin: 0;">
                                <div class="card-title">Region of Interest (ROI)</div>
                                <p style="font-size: 13px; color: var(--text-3); margin-bottom: 12px;">
                                    Click and drag on the image to select the area containing the value you want to extract.
                                </p>
                                <div class="roi-display">
                                    <div class="roi-values">
                                        <div class="roi-value">
                                            <div class="roi-value-label">X</div>
                                            <div class="roi-value-num" id="roi-x">0</div>
                                        </div>
                                        <div class="roi-value">
                                            <div class="roi-value-label">Y</div>
                                            <div class="roi-value-num" id="roi-y">0</div>
                                        </div>
                                        <div class="roi-value">
                                            <div class="roi-value-label">Width</div>
                                            <div class="roi-value-num" id="roi-w">0</div>
                                        </div>
                                        <div class="roi-value">
                                            <div class="roi-value-label">Height</div>
                                            <div class="roi-value-num" id="roi-h">0</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 12px; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 13px; color: var(--text-2);">ROI Rotation:</span>
                                    <button class="btn btn-secondary btn-sm" onclick="rotateROI(-90)" title="Rotate 90° Left">↺</button>
                                    <span id="roi-rotation" style="min-width: 40px; text-align: center; font-weight: 500;">0°</span>
                                    <button class="btn btn-secondary btn-sm" onclick="rotateROI(90)" title="Rotate 90° Right">↻</button>
                                    <input type="number" id="roi-rotation-input" value="0" min="-180" max="180" step="1"
                                           style="width: 60px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-2); color: var(--text-1);"
                                           onchange="setROIRotation(this.value)" title="Enter custom rotation angle">
                                </div>
                                <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button class="btn btn-secondary btn-sm" onclick="clearROI()">Clear</button>
                                    <button class="btn btn-primary btn-sm" onclick="testExtraction()">Test Extract</button>
                                    <button class="btn btn-secondary btn-sm" onclick="openOCRConfigModal()" title="Configure OCR Providers">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <circle cx="12" cy="12" r="3"></circle>
                                            <path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"></path>
                                        </svg>
                                        OCR Config
                                    </button>
                                </div>
                            </div>

                            <div class="card" style="margin: 0;">
                                <div class="card-title" style="justify-content: space-between;">
                                    <span>Extraction Result</span>
                                    <button class="btn btn-success btn-sm" onclick="saveExtractionROI()" id="add-to-roi-btn" style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Save ROI
                                    </button>
                                </div>
                                <div class="result-display" id="result-display">
                                    <div id="result-roi-preview" style="display: none; margin-bottom: 12px; border-radius: 6px; overflow: hidden; background: var(--bg);"></div>
                                    <div class="result-value" id="result-value">--</div>
                                    <div class="result-raw" id="result-raw">Draw ROI and click Test Extract</div>
                                    <div class="result-confidence" id="result-confidence"></div>
                                    <div id="all-providers-results" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);"></div>
                                </div>
                            </div>

                            <div class="card" style="margin: 0;">
                                <div class="card-title">Save as Template</div>
                                <p style="font-size: 13px; color: var(--text-3); margin-bottom: 12px;">
                                    Save this ROI as a template to track it even if the camera moves or rotates.
                                </p>
                                <div class="form-group">
                                    <input type="text" id="template-name-input" class="form-input" placeholder="Template name">
                                </div>
                                <button class="btn btn-success btn-sm" onclick="saveTemplate()">Save Template</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Templates Page -->
            <div id="page-templates" class="page">
                <div class="card">
                    <div class="card-title">Saved Templates</div>
                    <p style="font-size: 13px; color: var(--text-3); margin-bottom: 16px;">
                        Templates allow automatic tracking of the ROI even when the camera view changes, rotates, or moves.
                    </p>
                    <div id="templates-list" class="grid grid-3"></div>
                </div>
            </div>

            <!-- Discover Page -->
            <div id="page-discover" class="page">
                <div class="card">
                    <div class="card-title" style="justify-content: space-between;">
                        <span>Network Discovery (ONVIF)</span>
                        <button class="btn btn-primary" onclick="startDiscovery()" id="discover-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            Scan Network
                        </button>
                    </div>
                    <div id="discovery-list" class="grid grid-2">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <h3>No cameras discovered</h3>
                            <p>Click "Scan Network" to find ONVIF cameras</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Settings Page -->
            <div id="page-ai-settings" class="page">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>OCR Provider Configuration</span>
                        <span id="ml-status-badge" class="ml-status-badge unavailable">ML: Loading...</span>
                    </div>
                    <p style="font-size: 13px; color: var(--text-3); margin-bottom: 16px;">
                        Configure multiple OCR providers per camera. Providers run in order, best result is selected.
                    </p>

                    <div class="form-group">
                        <label class="form-label">Select Camera</label>
                        <select id="ai-camera-select" class="form-input" onchange="onAICameraChange()">
                            <option value="">-- Select Camera --</option>
                        </select>
                    </div>

                    <div id="ai-camera-config" style="display: none;">
                        <!-- Provider List -->
                        <div class="form-group">
                            <label class="form-label">OCR Providers (drag to reorder)</label>
                            <div id="provider-list" class="provider-list"></div>
                            <button type="button" class="add-provider-btn" onclick="showAddProviderDialog()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Add Provider
                            </button>
                        </div>

                        <!-- Provider Config Panel (shows when configuring a provider) -->
                        <div id="provider-config-panel" class="provider-config-panel" style="display: none;">
                            <div class="panel-title">
                                <span id="config-panel-title">Configure Provider</span>
                                <button class="btn btn-sm" onclick="closeProviderConfig()">×</button>
                            </div>
                            <div id="provider-config-fields"></div>
                            <button class="btn btn-primary btn-sm" onclick="saveProviderConfig()" style="margin-top: 12px;">Save Provider Settings</button>
                        </div>

                        <!-- ML ROI Locator Option -->
                        <div class="form-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="use-ml-roi-locator">
                                <span>Use ML to auto-locate ROI (requires trained ML model)</span>
                            </label>
                            <p style="font-size: 12px; color: var(--text-3); margin-top: 4px;">
                                When enabled, uses CLIP embeddings to find ROI regions based on validated examples.
                            </p>
                        </div>

                        <!-- Scene Description Option -->
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="ai-enable-description">
                                <span>Generate video scene descriptions (requires AI vision provider)</span>
                            </label>
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: 16px;">
                            <button class="btn btn-primary" onclick="saveMultiProviderConfig()">Save Configuration</button>
                        </div>
                    </div>
                </div>

                <!-- Test Providers Section -->
                <div class="card" id="ai-test-section" style="display: none;">
                    <div class="card-title">Test All Providers</div>
                    <p style="font-size: 13px; color: var(--text-3); margin-bottom: 16px;">
                        Test all configured providers and compare results.
                    </p>

                    <div class="form-group">
                        <label class="form-label">Image Source</label>
                        <select id="ai-test-source" class="form-input" onchange="onAITestSourceChange()">
                            <option value="upload">Upload Image</option>
                            <option value="camera">Camera Live Preview</option>
                        </select>
                    </div>

                    <div id="ai-test-upload-section">
                        <div class="form-group">
                            <label class="form-label">Select Image</label>
                            <input type="file" id="ai-test-file" accept="image/*" class="form-input" onchange="onAITestFileSelect()">
                        </div>
                        <div id="ai-test-preview-upload" style="margin-bottom: 16px; display: none;">
                            <img id="ai-test-preview-img" style="max-width: 100%; max-height: 200px; border-radius: 6px; border: 1px solid var(--border);">
                        </div>
                    </div>

                    <div id="ai-test-camera-section" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Select Camera</label>
                            <select id="ai-test-camera" class="form-input" onchange="onAITestCameraChange()">
                                <option value="">-- Select Camera --</option>
                            </select>
                        </div>
                        <div id="ai-test-preview-camera" style="margin-bottom: 16px; display: none;">
                            <p style="font-size: 12px; color: var(--text-3); margin-bottom: 8px;">Camera Preview (ROI area highlighted):</p>
                            <img id="ai-test-camera-img" style="max-width: 100%; max-height: 200px; border-radius: 6px; border: 1px solid var(--border);">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="testAllProviders()" id="test-ai-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Test All Providers
                    </button>
                </div>

                <div class="card" id="ai-test-results" style="display: none;">
                    <div class="card-title">Test Results</div>
                    <div id="ai-test-content"></div>
                </div>
            </div>
        </main>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot online" id="status-dot"></div>
                <span id="status-text">Connected</span>
            </div>
            <div class="status-item">
                <span id="camera-count">0 cameras</span>
            </div>
        </div>
    </div>

    <!-- Add/Edit Camera Modal -->
    <div class="modal" id="camera-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="camera-modal-title">Add Camera</h3>
                <button class="modal-close" onclick="closeCameraModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="camera-edit-name">
                <div class="form-group">
                    <label class="form-label">Camera Name *</label>
                    <input type="text" id="camera-name" class="form-input" placeholder="e.g., Boiler Temperature">
                </div>

                <!-- URL Input Mode Toggle -->
                <div class="form-group">
                    <label class="form-label">Stream URL *</label>
                    <div class="url-mode-toggle">
                        <button type="button" class="url-mode-btn active" id="url-mode-full" onclick="setUrlMode('full')">Full URL</button>
                        <button type="button" class="url-mode-btn" id="url-mode-build" onclick="setUrlMode('build')">Build URL</button>
                    </div>
                </div>

                <!-- Full URL Input -->
                <div class="form-group url-input-full" id="url-input-full">
                    <input type="text" id="camera-url" class="form-input" placeholder="rtsp://192.168.1.100:554/stream1" oninput="parseUrlToFields()">
                    <small class="form-hint">Enter full RTSP/HTTP URL (credentials will be extracted automatically)</small>
                </div>

                <!-- Build URL Inputs -->
                <div class="url-input-build" id="url-input-build" style="display: none;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 0 0 100px;">
                            <label class="form-label">Protocol</label>
                            <select id="camera-protocol" class="form-select" onchange="buildUrlFromFields()">
                                <option value="rtsp">RTSP</option>
                                <option value="http">HTTP</option>
                                <option value="https">HTTPS</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Host/IP *</label>
                            <input type="text" id="camera-host" class="form-input" placeholder="192.168.1.100" oninput="buildUrlFromFields()">
                        </div>
                        <div class="form-group" style="flex: 0 0 80px;">
                            <label class="form-label">Port</label>
                            <input type="text" id="camera-port" class="form-input" placeholder="554" oninput="buildUrlFromFields()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stream Path</label>
                        <input type="text" id="camera-path" class="form-input" placeholder="/stream1" oninput="buildUrlFromFields()">
                        <small class="form-hint">Common paths: /stream1, /Streaming/Channels/101, /cam/realmonitor?channel=1&subtype=0</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="camera-username" class="form-input" oninput="buildUrlFromFields()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="camera-password" class="form-input" oninput="buildUrlFromFields()">
                    </div>
                </div>

                <!-- Generated URL Preview -->
                <div class="form-group url-preview" id="url-preview" style="display: none;">
                    <label class="form-label">Generated URL</label>
                    <div class="url-preview-text" id="url-preview-text"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Value Name</label>
                        <input type="text" id="camera-value-name" class="form-input" placeholder="Temperature" value="Value">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit</label>
                        <select id="camera-unit" class="form-select">
                            <option value="">None</option>
                            <option value="°C">°C (Celsius)</option>
                            <option value="°F">°F (Fahrenheit)</option>
                            <option value="K">K (Kelvin)</option>
                            <option value="bar">bar (Pressure)</option>
                            <option value="psi">psi (Pressure)</option>
                            <option value="kPa">kPa (Pressure)</option>
                            <option value="%">% (Percentage)</option>
                            <option value="V">V (Voltage)</option>
                            <option value="A">A (Amperage)</option>
                            <option value="W">W (Watts)</option>
                            <option value="kWh">kWh (Energy)</option>
                            <option value="L">L (Liters)</option>
                            <option value="m³">m³ (Cubic meters)</option>
                            <option value="Hz">Hz (Frequency)</option>
                            <option value="RPM">RPM (Rotation)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Min Value (Optional)</label>
                        <input type="number" id="camera-min-value" class="form-input" placeholder="e.g., 0" step="any">
                        <p style="font-size: 11px; color: var(--text-3); margin-top: 4px;">Ignore readings below this value</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Value (Optional)</label>
                        <input type="number" id="camera-max-value" class="form-input" placeholder="e.g., 100" step="any">
                        <p style="font-size: 11px; color: var(--text-3); margin-top: 4px;">Ignore readings above this value</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Preprocessing</label>
                    <select id="camera-preprocessing" class="form-select">
                        <option value="auto">Auto (Recommended)</option>
                        <option value="none">None</option>
                        <option value="threshold">Threshold</option>
                        <option value="adaptive">Adaptive</option>
                        <option value="invert">Invert</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Template (for auto-tracking)</label>
                    <select id="camera-template" class="form-select">
                        <option value="">None</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" id="camera-use-template">
                        <label for="camera-use-template">Use template matching (auto-find ROI)</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCameraModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCamera()">Save Camera</button>
            </div>
        </div>
    </div>

    <!-- OCR Config Modal -->
    <div class="modal" id="ocr-config-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">OCR Configuration - <span id="ocr-config-camera-name"></span></h3>
                <button class="modal-close" onclick="closeOCRConfigModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="font-size: 13px; color: var(--text-3); margin-bottom: 16px;">
                    Configure OCR providers for this camera. Providers run in order, best result is selected.
                </p>

                <!-- Provider List -->
                <div class="form-group">
                    <label class="form-label">OCR Providers (drag to reorder)</label>
                    <div id="ocr-provider-list" class="provider-list"></div>
                    <button type="button" class="add-provider-btn" onclick="showAddProviderDialogModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Provider
                    </button>
                </div>

                <!-- Provider Config Panel -->
                <div id="ocr-provider-config-panel" class="provider-config-panel" style="display: none;">
                    <div class="panel-title">
                        <span id="ocr-config-panel-title">Configure Provider</span>
                        <button class="btn btn-sm" onclick="closeOCRProviderConfig()">×</button>
                    </div>
                    <div id="ocr-provider-config-fields"></div>
                    <button class="btn btn-primary btn-sm" onclick="saveOCRProviderConfig()" style="margin-top: 12px;">Save Provider Settings</button>
                </div>

                <!-- ML ROI Locator Option -->
                <div class="form-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="ocr-use-ml-roi-locator">
                        <span>Use ML to auto-locate ROI</span>
                    </label>
                </div>

                <!-- Scene Description Option -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="ocr-enable-description">
                        <span>Generate scene descriptions (requires AI vision provider)</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOCRConfigModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveOCRConfig()">Save Configuration</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // State
        let cameras = {};
        let values = {};
        let templates = [];
        let currentROI = { x: 0, y: 0, width: 0, height: 0, rotation: 0 };
        let isDrawing = false;
        let startX, startY;
        let previewImage = null;
        let imageScale = 1;
        let zoomLevel = 1;
        let liveUpdateInterval = null;
        let isLivePaused = false;
        let previewMode = 'edit';  // 'edit' or 'test'
        let lastExtractionResult = null;  // Store last test extraction for saving

        function setPreviewMode(mode) {
            previewMode = mode;
            document.getElementById('mode-edit-btn').classList.toggle('active', mode === 'edit');
            document.getElementById('mode-test-btn').classList.toggle('active', mode === 'test');
            drawROI();  // Redraw to show/hide ROI based on mode
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            startLiveUpdates();
            setupCanvas();
            setupZoomWheel();
        });

        function startLiveUpdates() {
            if (liveUpdateInterval) clearInterval(liveUpdateInterval);
            liveUpdateInterval = setInterval(loadValues, 5000);
        }

        function stopLiveUpdates() {
            if (liveUpdateInterval) {
                clearInterval(liveUpdateInterval);
                liveUpdateInterval = null;
            }
        }

        function toggleLiveUpdates() {
            isLivePaused = !isLivePaused;
            const badge = document.getElementById('live-badge');
            const pauseBtn = document.getElementById('pause-btn');
            const resumeBtn = document.getElementById('resume-btn');

            if (isLivePaused) {
                stopLiveUpdates();
                badge.textContent = 'PAUSED';
                badge.classList.add('paused');
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'inline-flex';
            } else {
                startLiveUpdates();
                loadValues(); // Refresh immediately
                badge.textContent = 'LIVE';
                badge.classList.remove('paused');
                pauseBtn.style.display = 'inline-flex';
                resumeBtn.style.display = 'none';
            }
        }

        // Zoom & PTZ Functions
        function setupZoomWheel() {
            const frame = document.getElementById('preview-frame');
            frame.addEventListener('wheel', (e) => {
                if (!previewImage) return;
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            }, { passive: false });
        }

        function zoomIn() {
            if (zoomLevel < 4) {
                zoomLevel = Math.min(4, zoomLevel + 0.25);
                applyZoom();
            }
        }

        function zoomOut() {
            if (zoomLevel > 0.25) {
                zoomLevel = Math.max(0.25, zoomLevel - 0.25);
                applyZoom();
            }
        }

        function resetZoom() {
            zoomLevel = 1;
            applyZoom();
        }

        async function ptzMove(direction) {
            const select = document.getElementById('preview-camera-select');
            const cameraName = select.value;
            if (!cameraName) {
                toast('Please select a camera first', 'error');
                return;
            }

            try {
                const res = await fetch('api/ptz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ camera: cameraName, direction: direction })
                });
                const result = await res.json();
                if (result.error) {
                    toast(result.error, 'error');
                } else {
                    toast(`PTZ: ${direction}`, 'success');
                    // Refresh preview after PTZ move
                    setTimeout(() => refreshPreview(), 500);
                }
            } catch (e) {
                toast('PTZ command failed: ' + e.message, 'error');
            }
        }

        function applyZoom() {
            const wrapper = document.getElementById('preview-wrapper');
            const img = document.getElementById('preview-image');
            const canvas = document.getElementById('preview-canvas');

            if (!previewImage) return;

            // Apply zoom
            const scaledWidth = previewImage.width * zoomLevel;
            const scaledHeight = previewImage.height * zoomLevel;

            img.style.width = scaledWidth + 'px';
            img.style.height = scaledHeight + 'px';

            wrapper.style.width = scaledWidth + 'px';
            wrapper.style.height = scaledHeight + 'px';

            // Update canvas
            canvas.width = scaledWidth;
            canvas.height = scaledHeight;
            canvas.style.width = scaledWidth + 'px';
            canvas.style.height = scaledHeight + 'px';

            // Update scale factor for ROI calculations
            imageScale = zoomLevel;

            // Update zoom level display
            document.getElementById('zoom-level').textContent = Math.round(zoomLevel * 100) + '%';

            drawROI();
        }

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                showPage(btn.dataset.page);
            });
        });

        function showPage(page) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            document.getElementById(`page-${page}`).classList.add('active');

            if (page === 'live') populateCameraSelect();
            if (page === 'templates') loadTemplates();
        }

        // Data Loading
        async function loadData() {
            await Promise.all([loadCameras(), loadValues(), loadTemplates()]);
        }

        async function loadCameras() {
            try {
                const res = await fetch('api/cameras');
                cameras = await res.json();
                renderCameras();
                updateStatus();
            } catch (e) {
                console.error('Failed to load cameras:', e);
            }
        }

        async function loadValues() {
            try {
                const res = await fetch('api/values');
                values = await res.json();
                renderValues();
                loadHistory();
            } catch (e) {
                console.error('Failed to load values:', e);
            }
        }

        let historyData = {};
        let selectedHistoryCamera = null;
        let historyViewMode = 'table';  // 'table', 'card', 'chart'

        async function loadHistory() {
            try {
                const res = await fetch('api/history');
                historyData = await res.json();
                renderHistory();
            } catch (e) {
                console.error('Failed to load history:', e);
            }
        }

        async function clearHistory() {
            if (!selectedHistoryCamera) {
                showToast('No camera selected', 'error');
                return;
            }
            if (!confirm(`Clear all history for "${selectedHistoryCamera}"?`)) {
                return;
            }
            try {
                const res = await fetch(`api/history/${encodeURIComponent(selectedHistoryCamera)}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.status === 'ok') {
                    showToast('History cleared', 'success');
                    loadHistory();
                } else {
                    showToast(data.message || 'Failed to clear history', 'error');
                }
            } catch (e) {
                console.error('Failed to clear history:', e);
                showToast('Failed to clear history', 'error');
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            const cameraNames = Object.keys(historyData);

            if (cameraNames.length === 0) {
                container.innerHTML = '<p style="color: var(--text-3);">No history available yet</p>';
                return;
            }

            // Auto-select first camera if none selected
            if (!selectedHistoryCamera || !historyData[selectedHistoryCamera]) {
                selectedHistoryCamera = cameraNames[0];
            }

            // Render tabs for each camera
            const tabs = cameraNames.map(name => `
                <button class="history-tab ${name === selectedHistoryCamera ? 'active' : ''}"
                        onclick="selectHistoryCamera('${name}')">${name}</button>
            `).join('');

            // View mode toggle
            const viewModeHtml = `
                <div style="display: flex; gap: 4px; margin-left: auto;">
                    <button class="btn btn-sm ${historyViewMode === 'table' ? 'btn-primary' : 'btn-secondary'}" onclick="setHistoryViewMode('table')" title="Table View">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="3" y1="15" x2="21" y2="15"></line>
                            <line x1="9" y1="3" x2="9" y2="21"></line>
                        </svg>
                    </button>
                    <button class="btn btn-sm ${historyViewMode === 'card' ? 'btn-primary' : 'btn-secondary'}" onclick="setHistoryViewMode('card')" title="Card View">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                    <button class="btn btn-sm ${historyViewMode === 'chart' ? 'btn-primary' : 'btn-secondary'}" onclick="setHistoryViewMode('chart')" title="Chart View">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </button>
                </div>
            `;

            const history = historyData[selectedHistoryCamera] || [];
            const camera = cameras[selectedHistoryCamera];
            const unit = camera?.unit || '';

            let contentHtml = '';
            if (history.length > 0) {
                if (historyViewMode === 'table') {
                    contentHtml = renderHistoryTable(history, unit);
                } else if (historyViewMode === 'card') {
                    contentHtml = renderHistoryCards(history, unit);
                } else if (historyViewMode === 'chart') {
                    contentHtml = renderHistoryChart(history, unit);
                }
            } else {
                contentHtml = '<p style="color: var(--text-3);">No readings yet for this camera</p>';
            }

            container.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <div class="history-tabs" style="margin-bottom: 0;">${tabs}</div>
                    ${viewModeHtml}
                </div>
                ${contentHtml}
            `;

            // If chart mode, render the chart
            if (historyViewMode === 'chart' && history.length > 0) {
                renderHistoryChartCanvas(history, unit);
            }
        }

        function renderHistoryTable(history, unit) {
            const rows = history.slice().reverse().map((entry, index) => {
                const time = new Date(entry.timestamp * 1000).toLocaleString();
                const confidence = entry.confidence || 0;
                const isLowConfidence = confidence < 80;
                const valueClass = isLowConfidence ? 'low-confidence' : '';
                const valueDisplay = entry.error
                    ? `<span class="error-cell">${entry.error}</span>`
                    : `<span class="${valueClass}">${entry.value !== null ? entry.value : '--'} ${unit}</span>`;

                // Confidence bar
                const barClass = confidence >= 80 ? 'high' : confidence >= 50 ? 'medium' : 'low';
                const confidenceDisplay = entry.confidence
                    ? `<span class="confidence-text">${confidence.toFixed(0)}%</span><div class="confidence-bar"><div class="confidence-bar-fill ${barClass}" style="width: ${confidence}%"></div></div>`
                    : '--';

                // Thumbnail
                const thumbnailHtml = entry.roi_image_id
                    ? `<img class="history-thumbnail" src="api/history-image/${encodeURIComponent(selectedHistoryCamera)}/${entry.roi_image_id}" onerror="this.outerHTML='<div class=\\'history-thumbnail-placeholder\\'>N/A</div>'">`
                    : '<div class="history-thumbnail-placeholder">N/A</div>';

                return `
                    <tr onclick="showHistoryDetail(${JSON.stringify(entry).replace(/"/g, '&quot;')}, '${unit}')" style="cursor: pointer;">
                        <td class="order-cell">${index + 1}</td>
                        <td style="width: 60px;">${thumbnailHtml}</td>
                        <td>${time}</td>
                        <td class="value-cell">${valueDisplay}</td>
                        <td>${confidenceDisplay}</td>
                        <td>${entry.ocr_provider || 'tesseract'}</td>
                    </tr>
                `;
            }).join('');

            return `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th class="order-header">#</th>
                            <th>ROI</th>
                            <th>Time</th>
                            <th class="value-header">Value</th>
                            <th>Confidence</th>
                            <th>Provider</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function renderHistoryCards(history, unit) {
            const cards = history.slice().reverse().map((entry, index) => {
                const time = new Date(entry.timestamp * 1000).toLocaleString();
                const confidence = entry.confidence || 0;
                const isLowConfidence = confidence < 80;
                const valueClass = isLowConfidence ? 'low-confidence' : '';
                const barClass = confidence >= 80 ? 'high' : confidence >= 50 ? 'medium' : 'low';

                const thumbnailHtml = entry.roi_image_id
                    ? `<img style="width: 100%; height: 80px; object-fit: cover; border-radius: 6px;" src="api/history-image/${encodeURIComponent(selectedHistoryCamera)}/${entry.roi_image_id}" onerror="this.style.display='none'">`
                    : '';

                return `
                    <div style="background: var(--bg-3); border-radius: 8px; padding: 12px; cursor: pointer;" onclick="showHistoryDetail(${JSON.stringify(entry).replace(/"/g, '&quot;')}, '${unit}')">
                        ${thumbnailHtml}
                        <div style="font-size: 24px; font-weight: 700; color: ${isLowConfidence ? 'var(--error)' : 'var(--primary)'}; margin: 8px 0;">
                            ${entry.value !== null ? entry.value : '--'} ${unit}
                        </div>
                        <div style="font-size: 12px; color: var(--text-3);">${time}</div>
                        <div style="margin-top: 8px;">
                            <div class="confidence-bar" style="width: 100%;"><div class="confidence-bar-fill ${barClass}" style="width: ${confidence}%"></div></div>
                            <div style="font-size: 11px; color: var(--text-3); margin-top: 4px;">${confidence.toFixed(0)}% • ${entry.ocr_provider || 'tesseract'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="grid grid-3" style="gap: 12px;">${cards}</div>`;
        }

        function renderHistoryChart(history, unit) {
            return `
                <div style="background: var(--bg-3); border-radius: 8px; padding: 16px;">
                    <canvas id="history-chart" height="250"></canvas>
                </div>
            `;
        }

        function renderHistoryChartCanvas(history, unit) {
            const canvas = document.getElementById('history-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width - 32;
            canvas.height = 250;

            const values = history.map(e => e.value).filter(v => v !== null);
            if (values.length === 0) return;

            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const range = maxVal - minVal || 1;
            const padding = { top: 30, right: 20, bottom: 40, left: 50 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;

            // Clear canvas
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-3').trim() || '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw grid lines
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(canvas.width - padding.right, y);
                ctx.stroke();
            }

            // Draw Y axis labels
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '11px system-ui';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const val = maxVal - (range / 5) * i;
                const y = padding.top + (chartHeight / 5) * i;
                ctx.fillText(val.toFixed(1), padding.left - 8, y + 4);
            }

            // Draw line chart
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();

            history.forEach((entry, i) => {
                if (entry.value === null) return;
                const x = padding.left + (i / (history.length - 1 || 1)) * chartWidth;
                const y = padding.top + chartHeight - ((entry.value - minVal) / range) * chartHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Draw points
            ctx.fillStyle = '#3b82f6';
            history.forEach((entry, i) => {
                if (entry.value === null) return;
                const x = padding.left + (i / (history.length - 1 || 1)) * chartWidth;
                const y = padding.top + chartHeight - ((entry.value - minVal) / range) * chartHeight;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });

            // X axis label
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.textAlign = 'center';
            ctx.fillText('Time →', canvas.width / 2, canvas.height - 8);

            // Y axis label
            ctx.save();
            ctx.translate(12, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(`Value (${unit})`, 0, 0);
            ctx.restore();
        }

        function setHistoryViewMode(mode) {
            historyViewMode = mode;
            renderHistory();
        }

        function showHistoryDetail(entry, unit) {
            const time = new Date(entry.timestamp * 1000).toLocaleString();
            const confidence = entry.confidence || 0;
            const barClass = confidence >= 80 ? 'high' : confidence >= 50 ? 'medium' : 'low';

            const imageHtml = entry.roi_image_id
                ? `<img class="history-detail-image" src="api/history-image/${encodeURIComponent(selectedHistoryCamera)}/${entry.roi_image_id}" onerror="this.style.display='none'">`
                : '';

            // Build provider results section if available
            let providerResultsHtml = '';
            if (entry.provider_results && entry.provider_results.length > 0) {
                const providerNames = {
                    'tesseract': 'Tesseract OCR',
                    'easyocr': 'EasyOCR',
                    'paddleocr': 'PaddleOCR',
                    'ml': 'ML (TrOCR)',
                    'openai': 'OpenAI',
                    'anthropic': 'Anthropic',
                    'google': 'Google Gemini',
                    'ollama': 'Ollama',
                    'google-vision': 'Google Vision',
                    'azure-ocr': 'Azure OCR',
                    'aws-textract': 'AWS Textract'
                };
                providerResultsHtml = `
                    <div class="history-detail-item full-width" style="margin-top: 12px;">
                        <label>All Provider Results</label>
                        <div class="provider-results-list" style="margin-top: 8px;">
                            ${entry.provider_results.map(r => {
                                const isSelected = r.provider === entry.ocr_provider;
                                const pName = providerNames[r.provider] || r.provider;
                                return `
                                    <div class="provider-result-item ${isSelected ? 'selected' : ''}">
                                        <div>
                                            <div class="result-provider">${pName} ${isSelected ? '✓' : ''}</div>
                                            <div class="result-confidence">${r.confidence ? r.confidence.toFixed(0) + '%' : ''}</div>
                                        </div>
                                        <div class="result-value" style="color: ${r.error ? 'var(--error)' : 'var(--text-1)'}">
                                            ${r.error || r.value || '--'}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            const dialog = document.createElement('div');
            dialog.className = 'history-detail-dialog';
            dialog.onclick = (e) => { if (e.target === dialog) dialog.remove(); };
            dialog.innerHTML = `
                <div class="history-detail-content">
                    <div class="history-detail-header">
                        <h3>Extraction Details</h3>
                        <button class="modal-close" onclick="this.closest('.history-detail-dialog').remove()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="history-detail-body">
                        ${imageHtml}
                        <div class="history-detail-grid">
                            <div class="history-detail-item">
                                <label>Value</label>
                                <div class="value" style="color: ${confidence < 80 ? 'var(--error)' : 'var(--primary)'};">
                                    ${entry.value !== null ? entry.value : '--'} ${unit}
                                </div>
                            </div>
                            <div class="history-detail-item">
                                <label>Date & Time</label>
                                <div class="value">${time}</div>
                            </div>
                            <div class="history-detail-item">
                                <label>Selected Provider</label>
                                <div class="value">${entry.ocr_provider || 'tesseract'}</div>
                            </div>
                            <div class="history-detail-item">
                                <label>Confidence</label>
                                <div class="value">
                                    ${confidence.toFixed(1)}%
                                    <div class="confidence-bar" style="margin-top: 4px;"><div class="confidence-bar-fill ${barClass}" style="width: ${confidence}%"></div></div>
                                </div>
                            </div>
                            <div class="history-detail-item">
                                <label>Raw Text</label>
                                <div class="value">${entry.raw_text || '--'}</div>
                            </div>
                            ${entry.video_description ? `
                            <div class="history-detail-item full-width">
                                <label>Video Description</label>
                                <div class="value" style="font-weight: normal; font-size: 13px;">${entry.video_description}</div>
                            </div>
                            ` : ''}
                            ${entry.error ? `
                            <div class="history-detail-item full-width">
                                <label>Error</label>
                                <div class="value" style="color: var(--error);">${entry.error}</div>
                            </div>
                            ` : ''}
                            ${providerResultsHtml}
                        </div>
                        ${entry.roi_image_id ? `
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <button class="btn btn-success" onclick="saveHistoryAsROI('${selectedHistoryCamera}', ${JSON.stringify(entry).replace(/"/g, '&quot;')})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right: 4px;">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Add to Saved ROIs
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        function promptForValidationValue(extractedValue, imageUrl) {
            return new Promise((resolve) => {
                const dialog = document.createElement('div');
                dialog.className = 'history-detail-dialog';
                dialog.onclick = (e) => { if (e.target === dialog) { dialog.remove(); resolve(null); } };

                const imgHtml = imageUrl ? `<img src="${imageUrl}" style="max-width: 100%; max-height: 150px; border-radius: 6px; margin-bottom: 12px; background: var(--bg);">` : '';

                dialog.innerHTML = `
                    <div class="history-detail-content" style="max-width: 400px;">
                        <div class="history-detail-header">
                            <h3>Save ROI with Validation</h3>
                            <button class="modal-close" onclick="this.closest('.history-detail-dialog').remove()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="history-detail-body">
                            ${imgHtml}
                            <div style="margin-bottom: 12px;">
                                <label class="form-label">Extracted Value (OCR Result)</label>
                                <div style="font-size: 20px; font-weight: 600; color: var(--primary);">${extractedValue !== null && extractedValue !== undefined ? extractedValue : '--'}</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Correct Value (for training)</label>
                                <input type="text" id="validation-value-input" class="form-input"
                                       value="${extractedValue !== null && extractedValue !== undefined ? extractedValue : ''}"
                                       placeholder="Enter the correct value" autofocus>
                                <p style="font-size: 11px; color: var(--text-3); margin-top: 4px;">
                                    Enter the actual correct value to help train OCR accuracy. Leave empty to skip validation.
                                </p>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 16px;">
                                <button class="btn btn-primary" id="save-with-validation-btn" style="flex: 1;">
                                    Save ROI
                                </button>
                                <button class="btn btn-secondary" onclick="this.closest('.history-detail-dialog').remove()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);

                // Focus and select input
                setTimeout(() => {
                    const input = document.getElementById('validation-value-input');
                    input.focus();
                    input.select();
                }, 100);

                // Handle save button
                document.getElementById('save-with-validation-btn').onclick = () => {
                    const validatedValue = document.getElementById('validation-value-input').value.trim();
                    dialog.remove();
                    resolve(validatedValue || null);
                };

                // Handle enter key
                document.getElementById('validation-value-input').onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('save-with-validation-btn').click();
                    }
                };
            });
        }

        async function saveHistoryAsROI(cameraName, entry) {
            // Prompt for validation value first
            const imageUrl = `api/history-image/${encodeURIComponent(cameraName)}/${entry.roi_image_id}`;
            const validatedValue = await promptForValidationValue(entry.value, imageUrl);
            if (validatedValue === null && !confirm('Save ROI without validation value?')) {
                return;
            }

            try {
                // Fetch the history image as base64
                const imgRes = await fetch(imageUrl);
                if (!imgRes.ok) {
                    toast('Failed to load history image', 'error');
                    return;
                }
                const blob = await imgRes.blob();
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64 = reader.result.split(',')[1];

                    // Save as new ROI
                    const res = await fetch(`api/saved-rois/${encodeURIComponent(cameraName)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roi: {
                                x: entry.roi_x || 0,
                                y: entry.roi_y || 0,
                                width: entry.roi_width || 0,
                                height: entry.roi_height || 0
                            },
                            screenshot: base64,
                            extracted_value: entry.value,
                            validated_value: validatedValue
                        })
                    });

                    if (res.ok) {
                        toast('Added to Saved ROIs', 'success');
                        document.querySelectorAll('.history-detail-dialog').forEach(d => d.remove());
                    } else {
                        const err = await res.json();
                        toast(err.error || 'Failed to save ROI', 'error');
                    }
                };
                reader.readAsDataURL(blob);
            } catch (e) {
                console.error('Failed to save history as ROI:', e);
                toast('Failed to save ROI', 'error');
            }
        }

        function selectHistoryCamera(name) {
            selectedHistoryCamera = name;
            renderHistory();
        }

        async function loadTemplates() {
            try {
                const res = await fetch('api/templates');
                templates = await res.json();
                renderTemplates();
                populateTemplateSelect();
            } catch (e) {
                console.error('Failed to load templates:', e);
            }
        }

        // Render Functions
        function renderValues() {
            const grid = document.getElementById('values-grid');
            const cameraEntries = Object.entries(cameras);
            const valueEntries = Object.entries(values);

            // No cameras configured at all
            if (cameraEntries.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        <h3>No cameras configured</h3>
                        <p>Add cameras to start extracting values</p>
                        <button class="btn btn-primary" onclick="showPage('cameras')">Add Camera</button>
                    </div>
                `;
                return;
            }

            // Cameras configured but no values extracted yet
            if (valueEntries.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <h3>Waiting for first extraction</h3>
                        <p>${cameraEntries.length} camera${cameraEntries.length > 1 ? 's' : ''} configured. Values will appear after first scan.</p>
                        <div class="loading" style="margin-top: 16px;"></div>
                    </div>
                `;
                return;
            }

            // Show all cameras, using values if available
            grid.innerHTML = cameraEntries.map(([name, camera]) => {
                const data = values[name] || {};
                const hasValue = data.value !== undefined && data.value !== null;
                const hasError = data.error;
                const statusClass = hasError ? 'error' : (hasValue ? 'ok' : 'pending');
                const statusText = hasError ? 'Error' : (hasValue ? 'OK' : 'Waiting');
                const displayValue = hasValue ? data.value : '--';
                const time = data.timestamp ? new Date(data.timestamp * 1000).toLocaleTimeString() : '';
                const confidence = data.confidence || 0;
                const isLowConfidence = hasValue && confidence < 80 && !hasError;
                const valueClass = isLowConfidence ? 'low-confidence' : '';

                const description = data.video_description || '';
                return `
                    <div class="value-card">
                        <div class="value-card-header">
                            <div class="value-card-name">${name}</div>
                            <div class="value-card-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="value-card-value ${valueClass}">
                            ${displayValue}<span class="value-card-unit">${camera.unit || ''}</span>
                        </div>
                        <div class="value-card-meta">
                            ${hasError ? `<span style="color: var(--error);">${data.error}</span>` :
                              (hasValue ? `Confidence: ${confidence.toFixed(0)}% • ${time}` : 'Waiting for first scan...')}
                            ${isLowConfidence ? '<span class="low-confidence-text"> (Low)</span>' : ''}
                        </div>
                        ${description ? `<div class="value-card-description">${description}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function maskPasswordInUrl(url) {
            // Mask password in URL like rtsp://user:password@host -> rtsp://user:****@host
            try {
                const urlPattern = /^((?:rtsp|http|https):\/\/)([^:]+):([^@]+)@(.+)$/i;
                const match = url.match(urlPattern);
                if (match) {
                    return `${match[1]}${match[2]}:****@${match[4]}`;
                }
                // Also handle URLs with password in query params
                return url.replace(/([?&]password=)[^&]+/gi, '$1****');
            } catch (e) {
                return url;
            }
        }

        function renderCameras() {
            const list = document.getElementById('cameras-list');
            const entries = Object.entries(cameras);

            if (entries.length === 0) {
                list.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        <h3>No cameras configured</h3>
                        <p>Click "Add Camera" to get started</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = entries.map(([name, cam]) => `
                <div class="camera-item">
                    <div class="camera-item-preview" id="preview-${name.replace(/\\s/g, '-')}">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-3);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                        </div>
                    </div>
                    <div class="camera-item-info">
                        <div class="camera-item-name">${name}</div>
                        <div class="camera-item-url">${maskPasswordInUrl(cam.stream_url)}</div>
                        <div style="font-size: 12px; color: var(--text-3); margin-top: 4px;">
                            ${cam.value_name}${cam.unit ? ' (' + cam.unit + ')' : ''} •
                            ROI: ${cam.roi_width > 0 ? `${cam.roi_width}x${cam.roi_height}` : 'Not set'}
                            ${cam.use_template_matching ? ' • Template: ' + cam.template_name : ''}
                        </div>
                    </div>
                    <div class="camera-item-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editCamera('${name}')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCamera('${name}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTemplates() {
            const list = document.getElementById('templates-list');

            if (templates.length === 0) {
                list.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="9" y1="21" x2="9" y2="9"></line>
                        </svg>
                        <h3>No templates saved</h3>
                        <p>Create templates from the Live Preview page</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = templates.map(t => `
                <div class="template-item">
                    <div class="template-preview">
                        <img src="api/templates/${t.name}/image" alt="${t.name}">
                    </div>
                    <div class="template-info">
                        <div class="template-name">${t.name}</div>
                        <div class="template-meta">
                            ROI: ${t.original_roi?.width || 0}x${t.original_roi?.height || 0}
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm btn-icon" onclick="deleteTemplate('${t.name}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        // Camera Modal
        function openAddCameraModal() {
            document.getElementById('camera-modal-title').textContent = 'Add Camera';
            document.getElementById('camera-edit-name').value = '';
            document.getElementById('camera-name').value = '';
            document.getElementById('camera-url').value = '';
            document.getElementById('camera-username').value = '';
            document.getElementById('camera-password').value = '';
            document.getElementById('camera-value-name').value = 'Value';
            document.getElementById('camera-unit').value = '°C';
            document.getElementById('camera-min-value').value = '';
            document.getElementById('camera-max-value').value = '';
            document.getElementById('camera-preprocessing').value = 'auto';
            document.getElementById('camera-template').value = '';
            document.getElementById('camera-use-template').checked = false;
            // Reset URL builder fields
            document.getElementById('camera-protocol').value = 'rtsp';
            document.getElementById('camera-host').value = '';
            document.getElementById('camera-port').value = '';
            document.getElementById('camera-path').value = '';
            document.getElementById('url-preview-text').textContent = '';
            setUrlMode('full');
            document.getElementById('camera-modal').classList.add('active');
        }

        function editCamera(name) {
            const cam = cameras[name];
            if (!cam) return;

            document.getElementById('camera-modal-title').textContent = 'Edit Camera';
            document.getElementById('camera-edit-name').value = name;
            document.getElementById('camera-name').value = cam.name;
            document.getElementById('camera-url').value = cam.stream_url;
            document.getElementById('camera-username').value = cam.username || '';
            document.getElementById('camera-password').value = cam.password || '';
            document.getElementById('camera-value-name').value = cam.value_name || 'Value';
            document.getElementById('camera-unit').value = cam.unit || '';
            document.getElementById('camera-min-value').value = cam.min_value !== null && cam.min_value !== undefined ? cam.min_value : '';
            document.getElementById('camera-max-value').value = cam.max_value !== null && cam.max_value !== undefined ? cam.max_value : '';
            document.getElementById('camera-preprocessing').value = cam.preprocessing || 'auto';
            document.getElementById('camera-template').value = cam.template_name || '';
            document.getElementById('camera-use-template').checked = cam.use_template_matching || false;
            // Parse existing URL to builder fields
            setUrlMode('full');
            parseUrlToFields();
            document.getElementById('camera-modal').classList.add('active');
        }

        function closeCameraModal() {
            document.getElementById('camera-modal').classList.remove('active');
        }

        // URL Mode Toggle
        let urlMode = 'full';
        function setUrlMode(mode) {
            urlMode = mode;
            document.getElementById('url-mode-full').classList.toggle('active', mode === 'full');
            document.getElementById('url-mode-build').classList.toggle('active', mode === 'build');
            document.getElementById('url-input-full').style.display = mode === 'full' ? 'block' : 'none';
            document.getElementById('url-input-build').style.display = mode === 'build' ? 'block' : 'none';
            document.getElementById('url-preview').style.display = mode === 'build' ? 'block' : 'none';

            if (mode === 'build') {
                parseUrlToFields();
                buildUrlFromFields();
            }
        }

        // Parse full URL to individual fields
        function parseUrlToFields() {
            const urlInput = document.getElementById('camera-url').value.trim();
            if (!urlInput) return;

            try {
                // Handle URLs with credentials in format: protocol://user:pass@host:port/path
                let protocol = 'rtsp';
                let host = '';
                let port = '';
                let path = '';
                let username = '';
                let password = '';

                // Extract protocol
                const protocolMatch = urlInput.match(/^(rtsp|https?):\/\//i);
                if (protocolMatch) {
                    protocol = protocolMatch[1].toLowerCase();
                }

                // Remove protocol for parsing
                let remainder = urlInput.replace(/^(rtsp|https?):\/\//i, '');

                // Extract credentials if present (user:pass@)
                const credMatch = remainder.match(/^([^:@]+):([^@]+)@/);
                if (credMatch) {
                    username = decodeURIComponent(credMatch[1]);
                    password = decodeURIComponent(credMatch[2]);
                    remainder = remainder.substring(credMatch[0].length);
                } else {
                    // Check for username only (user@)
                    const userMatch = remainder.match(/^([^:@]+)@/);
                    if (userMatch) {
                        username = decodeURIComponent(userMatch[1]);
                        remainder = remainder.substring(userMatch[0].length);
                    }
                }

                // Extract host:port/path
                const hostMatch = remainder.match(/^([^:\/]+)(?::(\d+))?(\/.*)?$/);
                if (hostMatch) {
                    host = hostMatch[1];
                    port = hostMatch[2] || '';
                    path = hostMatch[3] || '';
                }

                // Update fields
                document.getElementById('camera-protocol').value = protocol;
                document.getElementById('camera-host').value = host;
                document.getElementById('camera-port').value = port;
                document.getElementById('camera-path').value = path;

                // Only update username/password if extracted and fields are empty
                if (username && !document.getElementById('camera-username').value) {
                    document.getElementById('camera-username').value = username;
                }
                if (password && !document.getElementById('camera-password').value) {
                    document.getElementById('camera-password').value = password;
                }
            } catch (e) {
                console.error('Failed to parse URL:', e);
            }
        }

        // Build URL from individual fields
        function buildUrlFromFields() {
            const protocol = document.getElementById('camera-protocol').value;
            const host = document.getElementById('camera-host').value.trim();
            const port = document.getElementById('camera-port').value.trim();
            let path = document.getElementById('camera-path').value.trim();
            const username = document.getElementById('camera-username').value.trim();
            const password = document.getElementById('camera-password').value;

            if (!host) {
                document.getElementById('url-preview-text').textContent = 'Enter host/IP to generate URL';
                return;
            }

            // Ensure path starts with /
            if (path && !path.startsWith('/')) {
                path = '/' + path;
            }

            // Build URL
            let url = protocol + '://';

            // Add credentials if provided
            if (username) {
                url += encodeURIComponent(username);
                if (password) {
                    url += ':' + encodeURIComponent(password);
                }
                url += '@';
            }

            url += host;

            // Add port if specified
            if (port) {
                url += ':' + port;
            }

            url += path;

            // Update the main URL field and preview
            document.getElementById('camera-url').value = url;
            document.getElementById('url-preview-text').textContent = url;
        }

        async function saveCamera() {
            const editName = document.getElementById('camera-edit-name').value;
            const name = document.getElementById('camera-name').value.trim();
            const url = document.getElementById('camera-url').value.trim();

            if (!name || !url) {
                toast('Please fill in required fields', 'error');
                return;
            }

            const minValInput = document.getElementById('camera-min-value').value;
            const maxValInput = document.getElementById('camera-max-value').value;

            const data = {
                name: name,
                stream_url: url,
                username: document.getElementById('camera-username').value,
                password: document.getElementById('camera-password').value,
                value_name: document.getElementById('camera-value-name').value || 'Value',
                unit: document.getElementById('camera-unit').value,
                min_value: minValInput !== '' ? parseFloat(minValInput) : null,
                max_value: maxValInput !== '' ? parseFloat(maxValInput) : null,
                preprocessing: document.getElementById('camera-preprocessing').value,
                template_name: document.getElementById('camera-template').value,
                use_template_matching: document.getElementById('camera-use-template').checked,
                roi_x: cameras[editName]?.roi_x || 0,
                roi_y: cameras[editName]?.roi_y || 0,
                roi_width: cameras[editName]?.roi_width || 0,
                roi_height: cameras[editName]?.roi_height || 0,
                roi_rotation: cameras[editName]?.roi_rotation || 0,
            };

            try {
                let res;
                if (editName) {
                    res = await fetch(`api/cameras/${encodeURIComponent(editName)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch('api/cameras', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (res.ok) {
                    toast('Camera saved successfully', 'success');
                    closeCameraModal();
                    loadCameras();
                } else {
                    const err = await res.json();
                    toast(err.error || 'Failed to save camera', 'error');
                }
            } catch (e) {
                toast('Failed to save camera', 'error');
            }
        }

        async function deleteCamera(name) {
            if (!confirm(`Delete camera "${name}"?`)) return;

            try {
                const res = await fetch(`api/cameras/${encodeURIComponent(name)}`, { method: 'DELETE' });
                if (res.ok) {
                    toast('Camera deleted', 'success');
                    loadCameras();
                    loadValues();
                }
            } catch (e) {
                toast('Failed to delete camera', 'error');
            }
        }

        // Live Preview
        function populateCameraSelect() {
            const select = document.getElementById('live-camera-select');
            const cameraNames = Object.keys(cameras);
            select.innerHTML = '<option value="">-- Select a camera --</option>' +
                cameraNames.map(name => `<option value="${name}">${name}</option>`).join('');

            // Auto-select first camera if available and none selected
            if (cameraNames.length > 0 && !select.value) {
                select.value = cameraNames[0];
                loadLivePreview();
            }
        }

        function editSelectedCamera() {
            const select = document.getElementById('live-camera-select');
            const cameraName = select.value;
            if (!cameraName) {
                toast('Please select a camera first', 'error');
                return;
            }
            // Open edit dialog for the selected camera
            editCamera(cameraName);
        }

        function populateTemplateSelect() {
            const select = document.getElementById('camera-template');
            select.innerHTML = '<option value="">None</option>' +
                templates.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
        }

        async function loadLivePreview() {
            const name = document.getElementById('live-camera-select').value;
            if (!name) return;

            const cam = cameras[name];
            if (cam) {
                currentROI = {
                    x: cam.roi_x || 0,
                    y: cam.roi_y || 0,
                    width: cam.roi_width || 0,
                    height: cam.roi_height || 0,
                    rotation: cam.roi_rotation || 0
                };
                updateROIDisplay();
            }

            await refreshLivePreview();
            loadSavedROIs();
        }

        async function refreshLivePreview() {
            const name = document.getElementById('live-camera-select').value;
            if (!name) {
                toast('Please select a camera', 'error');
                return;
            }

            const placeholder = document.getElementById('preview-placeholder');
            placeholder.innerHTML = '<div class="loading"></div><p style="margin-top: 16px;">Loading preview...</p>';

            try {
                const res = await fetch(`api/capture/${encodeURIComponent(name)}`);
                const data = await res.json();

                if (data.error) {
                    placeholder.innerHTML = `<p style="color: var(--error);">${data.error}</p>`;
                    return;
                }

                const img = document.getElementById('preview-image');
                img.src = 'data:image/png;base64,' + data.frame;
                img.style.display = 'block';
                placeholder.style.display = 'none';

                img.onload = () => {
                    previewImage = { width: data.width, height: data.height };
                    // Reset zoom for new image
                    zoomLevel = 1;
                    setupCanvasSize();
                    drawROI();
                };

            } catch (e) {
                placeholder.innerHTML = `<p style="color: var(--error);">Failed to load preview</p>`;
            }
        }

        // Canvas & ROI
        let dragMode = 'none'; // 'none', 'draw', 'move', 'resize-tl', 'resize-tr', 'resize-bl', 'resize-br'
        let dragStartROI = null;
        const HANDLE_SIZE = 12; // Size of corner handles in image coordinates

        function getMousePos(canvas, e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            return {
                x: x / zoomLevel,
                y: y / zoomLevel
            };
        }

        function getHitTarget(pos) {
            if (currentROI.width === 0 || currentROI.height === 0) return 'draw';

            const roi = currentROI;
            const hs = HANDLE_SIZE / zoomLevel; // Adjust handle size for zoom
            const rotation = roi.rotation || 0;
            const rotationRad = rotation * Math.PI / 180;

            // Calculate ROI center
            const centerX = roi.x + roi.width / 2;
            const centerY = roi.y + roi.height / 2;

            // Helper to rotate a point around center
            function rotatePoint(px, py) {
                const cos = Math.cos(-rotationRad);
                const sin = Math.sin(-rotationRad);
                const dx = px - centerX;
                const dy = py - centerY;
                return {
                    x: cos * dx - sin * dy + centerX,
                    y: sin * dx + cos * dy + centerY
                };
            }

            // Rotate mouse position to unrotated coordinates
            const unrotatedPos = rotatePoint(pos.x, pos.y);

            // Check rotation handle (positioned above the ROI)
            const rotateHandleDistance = 30 / zoomLevel;
            const rotateHandleX = centerX;
            const rotateHandleY = roi.y - rotateHandleDistance;
            const rotatedHandle = {
                x: Math.cos(rotationRad) * (rotateHandleX - centerX) - Math.sin(rotationRad) * (rotateHandleY - centerY) + centerX,
                y: Math.sin(rotationRad) * (rotateHandleX - centerX) + Math.cos(rotationRad) * (rotateHandleY - centerY) + centerY
            };
            if (Math.abs(pos.x - rotatedHandle.x) < hs * 1.5 && Math.abs(pos.y - rotatedHandle.y) < hs * 1.5) return 'rotate';

            // Check corner handles (in unrotated space)
            if (Math.abs(unrotatedPos.x - roi.x) < hs && Math.abs(unrotatedPos.y - roi.y) < hs) return 'resize-tl';
            if (Math.abs(unrotatedPos.x - (roi.x + roi.width)) < hs && Math.abs(unrotatedPos.y - roi.y) < hs) return 'resize-tr';
            if (Math.abs(unrotatedPos.x - roi.x) < hs && Math.abs(unrotatedPos.y - (roi.y + roi.height)) < hs) return 'resize-bl';
            if (Math.abs(unrotatedPos.x - (roi.x + roi.width)) < hs && Math.abs(unrotatedPos.y - (roi.y + roi.height)) < hs) return 'resize-br';

            // Check if inside ROI (for moving) - in unrotated space
            if (unrotatedPos.x >= roi.x && unrotatedPos.x <= roi.x + roi.width &&
                unrotatedPos.y >= roi.y && unrotatedPos.y <= roi.y + roi.height) {
                return 'move';
            }

            return 'draw';
        }

        function updateCursor(canvas, pos) {
            if (!previewImage || currentROI.width === 0) {
                canvas.style.cursor = 'crosshair';
                return;
            }

            const target = getHitTarget(pos);
            switch (target) {
                case 'resize-tl':
                case 'resize-br':
                    canvas.style.cursor = 'nwse-resize';
                    break;
                case 'resize-tr':
                case 'resize-bl':
                    canvas.style.cursor = 'nesw-resize';
                    break;
                case 'move':
                    canvas.style.cursor = 'move';
                    break;
                case 'rotate':
                    canvas.style.cursor = 'grab';
                    break;
                default:
                    canvas.style.cursor = 'crosshair';
            }
        }

        function setupCanvas() {
            const canvas = document.getElementById('preview-canvas');

            canvas.addEventListener('mousedown', (e) => {
                if (!previewImage) return;
                e.preventDefault();
                const pos = getMousePos(canvas, e);

                dragMode = getHitTarget(pos);
                isDrawing = true;
                startX = pos.x;
                startY = pos.y;
                dragStartROI = { ...currentROI };
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!previewImage) return;
                e.preventDefault();
                const pos = getMousePos(canvas, e);

                // Update cursor based on position
                if (!isDrawing) {
                    updateCursor(canvas, pos);
                    return;
                }

                const dx = pos.x - startX;
                const dy = pos.y - startY;

                switch (dragMode) {
                    case 'move':
                        currentROI = {
                            x: Math.max(0, Math.round(dragStartROI.x + dx)),
                            y: Math.max(0, Math.round(dragStartROI.y + dy)),
                            width: dragStartROI.width,
                            height: dragStartROI.height
                        };
                        break;

                    case 'resize-tl':
                        currentROI = {
                            x: Math.round(Math.min(dragStartROI.x + dragStartROI.width - 10, dragStartROI.x + dx)),
                            y: Math.round(Math.min(dragStartROI.y + dragStartROI.height - 10, dragStartROI.y + dy)),
                            width: Math.max(10, Math.round(dragStartROI.width - dx)),
                            height: Math.max(10, Math.round(dragStartROI.height - dy))
                        };
                        break;

                    case 'resize-tr':
                        currentROI = {
                            x: dragStartROI.x,
                            y: Math.round(Math.min(dragStartROI.y + dragStartROI.height - 10, dragStartROI.y + dy)),
                            width: Math.max(10, Math.round(dragStartROI.width + dx)),
                            height: Math.max(10, Math.round(dragStartROI.height - dy))
                        };
                        break;

                    case 'resize-bl':
                        currentROI = {
                            x: Math.round(Math.min(dragStartROI.x + dragStartROI.width - 10, dragStartROI.x + dx)),
                            y: dragStartROI.y,
                            width: Math.max(10, Math.round(dragStartROI.width - dx)),
                            height: Math.max(10, Math.round(dragStartROI.height + dy))
                        };
                        break;

                    case 'resize-br':
                        currentROI = {
                            x: dragStartROI.x,
                            y: dragStartROI.y,
                            width: Math.max(10, Math.round(dragStartROI.width + dx)),
                            height: Math.max(10, Math.round(dragStartROI.height + dy))
                        };
                        break;

                    case 'rotate':
                        // Calculate rotation based on mouse position relative to ROI center
                        const centerX = dragStartROI.x + dragStartROI.width / 2;
                        const centerY = dragStartROI.y + dragStartROI.height / 2;
                        const angleRad = Math.atan2(pos.y - centerY, pos.x - centerX);
                        // Convert to degrees and offset by -90 (since handle is above)
                        let angleDeg = angleRad * 180 / Math.PI + 90;
                        // Snap to 15 degree increments when near
                        const snapThreshold = 5;
                        const snappedAngle = Math.round(angleDeg / 15) * 15;
                        if (Math.abs(angleDeg - snappedAngle) < snapThreshold) {
                            angleDeg = snappedAngle;
                        }
                        // Normalize to -180 to 180
                        while (angleDeg > 180) angleDeg -= 360;
                        while (angleDeg < -180) angleDeg += 360;
                        currentROI.rotation = Math.round(angleDeg);
                        break;

                    case 'draw':
                    default:
                        currentROI = {
                            x: Math.round(Math.min(startX, pos.x)),
                            y: Math.round(Math.min(startY, pos.y)),
                            width: Math.round(Math.abs(pos.x - startX)),
                            height: Math.round(Math.abs(pos.y - startY))
                        };
                        break;
                }

                updateROIDisplay();
                drawROI();
            });

            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
                dragMode = 'none';
            });

            canvas.addEventListener('mouseleave', () => {
                isDrawing = false;
                dragMode = 'none';
            });
        }

        function setupCanvasSize() {
            const canvas = document.getElementById('preview-canvas');
            const img = document.getElementById('preview-image');

            // Set canvas to match zoomed image size
            const width = previewImage.width * zoomLevel;
            const height = previewImage.height * zoomLevel;

            canvas.width = width;
            canvas.height = height;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            canvas.style.display = 'block';

            // Set image size
            img.style.width = width + 'px';
            img.style.height = height + 'px';

            // Show zoom controls
            document.getElementById('zoom-controls').style.display = 'flex';
            document.getElementById('zoom-level').textContent = Math.round(zoomLevel * 100) + '%';

            imageScale = zoomLevel;
        }

        function drawROI() {
            const canvas = document.getElementById('preview-canvas');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (currentROI.width > 0 && currentROI.height > 0) {
                const x = currentROI.x * imageScale;
                const y = currentROI.y * imageScale;
                const w = currentROI.width * imageScale;
                const h = currentROI.height * imageScale;
                const rotation = currentROI.rotation || 0;
                const rotationRad = rotation * Math.PI / 180;
                const centerX = x + w / 2;
                const centerY = y + h / 2;

                if (previewMode === 'test') {
                    // TEST mode: Full overlay with dark mask, rotated border, and value
                    // Draw semi-transparent overlay over entire canvas
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Clear the ROI area (with rotation)
                    ctx.save();
                    ctx.translate(centerX, centerY);
                    ctx.rotate(rotationRad);
                    ctx.clearRect(-w/2, -h/2, w, h);

                    // Draw ROI border (rotated)
                    ctx.strokeStyle = '#03a9f4';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(-w/2, -h/2, w, h);

                    // Draw corner handles (rotated)
                    const handleSize = 8;
                    ctx.fillStyle = '#03a9f4';
                    ctx.fillRect(-w/2 - handleSize/2, -h/2 - handleSize/2, handleSize, handleSize);
                    ctx.fillRect(w/2 - handleSize/2, -h/2 - handleSize/2, handleSize, handleSize);
                    ctx.fillRect(-w/2 - handleSize/2, h/2 - handleSize/2, handleSize, handleSize);
                    ctx.fillRect(w/2 - handleSize/2, h/2 - handleSize/2, handleSize, handleSize);

                    ctx.restore();

                    // Draw value if available (not rotated, at top of ROI)
                    const val = values[document.getElementById('live-camera-select').value];
                    if (val && val.value !== null) {
                        const label = val.value + (cameras[val.camera_name]?.unit || '');
                        ctx.font = 'bold 16px sans-serif';
                        const textWidth = ctx.measureText(label).width;

                        // Position label above the rotated ROI
                        const labelX = centerX - textWidth/2 - 6;
                        const labelY = centerY - Math.max(w, h)/2 - 30;

                        ctx.fillStyle = '#03a9f4';
                        ctx.fillRect(labelX, labelY, textWidth + 12, 22);

                        ctx.fillStyle = 'white';
                        ctx.fillText(label, labelX + 6, labelY + 16);
                    }
                } else {
                    // EDIT mode: Only blue border for drawing feedback (with rotation)
                    ctx.save();
                    ctx.translate(centerX, centerY);
                    ctx.rotate(rotationRad);

                    ctx.strokeStyle = '#03a9f4';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(-w/2, -h/2, w, h);

                    // Draw corner handles for resize (rotated)
                    const handleSize = 8;
                    ctx.fillStyle = '#03a9f4';
                    ctx.fillRect(-w/2 - handleSize/2, -h/2 - handleSize/2, handleSize, handleSize);
                    ctx.fillRect(w/2 - handleSize/2, -h/2 - handleSize/2, handleSize, handleSize);
                    ctx.fillRect(-w/2 - handleSize/2, h/2 - handleSize/2, handleSize, handleSize);
                    ctx.fillRect(w/2 - handleSize/2, h/2 - handleSize/2, handleSize, handleSize);

                    // Draw rotation handle (positioned above the ROI)
                    const rotateHandleDistance = 30;
                    ctx.beginPath();
                    ctx.moveTo(0, -h/2);
                    ctx.lineTo(0, -h/2 - rotateHandleDistance + 6);
                    ctx.strokeStyle = '#03a9f4';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Draw circular rotation handle
                    ctx.beginPath();
                    ctx.arc(0, -h/2 - rotateHandleDistance, 6, 0, Math.PI * 2);
                    ctx.fillStyle = '#03a9f4';
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    // Draw rotation icon (curved arrow) inside handle
                    ctx.beginPath();
                    ctx.arc(0, -h/2 - rotateHandleDistance, 3, -Math.PI * 0.7, Math.PI * 0.3);
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 1.5;
                    ctx.stroke();

                    ctx.restore();

                    // Show rotation value if non-zero
                    if (rotation !== 0) {
                        ctx.font = '11px sans-serif';
                        ctx.fillStyle = '#03a9f4';
                        ctx.textAlign = 'center';
                        ctx.fillText(rotation + '°', centerX, y - 40);
                    }
                }

                // Draw rotation indicator if rotation is set
                if (rotation !== 0) {
                    // Draw center point
                    ctx.fillStyle = '#ff9800';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, 4, 0, Math.PI * 2);
                    ctx.fill();

                    // Draw rotation arc indicator
                    ctx.strokeStyle = '#ff9800';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    const startAngle = -Math.PI / 2;
                    const endAngle = startAngle + rotationRad;
                    const arcRadius = Math.min(w, h) / 3;
                    ctx.arc(centerX, centerY, arcRadius, startAngle, endAngle, rotation < 0);
                    ctx.stroke();

                    // Draw arrow at end of arc
                    const arrowX = centerX + arcRadius * Math.cos(endAngle);
                    const arrowY = centerY + arcRadius * Math.sin(endAngle);
                    ctx.beginPath();
                    ctx.arc(arrowX, arrowY, 5, 0, Math.PI * 2);
                    ctx.fill();

                    // Draw rotation label
                    ctx.font = 'bold 12px sans-serif';
                    ctx.fillStyle = '#ff9800';
                    ctx.textAlign = 'center';
                    ctx.fillText(rotation + '°', centerX, centerY - arcRadius - 10);
                    ctx.textAlign = 'left'; // Reset
                }
            }
        }

        function updateROIDisplay() {
            document.getElementById('roi-x').textContent = currentROI.x;
            document.getElementById('roi-y').textContent = currentROI.y;
            document.getElementById('roi-w').textContent = currentROI.width;
            document.getElementById('roi-h').textContent = currentROI.height;
            document.getElementById('roi-rotation').textContent = (currentROI.rotation || 0) + '°';
            document.getElementById('roi-rotation-input').value = currentROI.rotation || 0;
        }

        function rotateROI(delta) {
            currentROI.rotation = ((currentROI.rotation || 0) + delta + 360) % 360;
            if (currentROI.rotation > 180) currentROI.rotation -= 360;
            updateROIDisplay();
            drawROI();
        }

        function setROIRotation(value) {
            currentROI.rotation = parseInt(value) || 0;
            // Clamp to -180 to 180
            while (currentROI.rotation > 180) currentROI.rotation -= 360;
            while (currentROI.rotation < -180) currentROI.rotation += 360;
            updateROIDisplay();
            drawROI();
        }

        function clearROI() {
            currentROI = { x: 0, y: 0, width: 0, height: 0, rotation: 0 };
            updateROIDisplay();
            drawROI();
        }

        async function testExtraction() {
            const name = document.getElementById('live-camera-select').value;
            if (!name) {
                toast('Please select a camera', 'error');
                return;
            }

            const preprocessing = document.getElementById('live-preprocessing').value;

            // Show loading state
            const resultValue = document.getElementById('result-value');
            const resultRaw = document.getElementById('result-raw');
            const resultConfidence = document.getElementById('result-confidence');
            const resultPreview = document.getElementById('result-roi-preview');
            const allProvidersEl = document.getElementById('all-providers-results');

            // IMMEDIATELY show captured ROI from current canvas
            if (currentROI.width > 0 && currentROI.height > 0 && currentImage) {
                // Create a temporary canvas to extract the ROI
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');

                // Get ROI coordinates (already in original image coordinates)
                const x = Math.round(currentROI.x);
                const y = Math.round(currentROI.y);
                const w = Math.round(currentROI.width);
                const h = Math.round(currentROI.height);

                // Ensure coordinates are within bounds
                const safeX = Math.max(0, Math.min(x, currentImage.width - 1));
                const safeY = Math.max(0, Math.min(y, currentImage.height - 1));
                const safeW = Math.min(w, currentImage.width - safeX);
                const safeH = Math.min(h, currentImage.height - safeY);

                tempCanvas.width = safeW;
                tempCanvas.height = safeH;
                tempCtx.drawImage(currentImage, safeX, safeY, safeW, safeH, 0, 0, safeW, safeH);

                // Show immediate preview
                resultPreview.innerHTML = `<img src="${tempCanvas.toDataURL('image/png')}" style="width: 100%; display: block;">`;
                resultPreview.style.display = 'block';
            }

            resultValue.textContent = '...';
            resultValue.style.color = 'var(--text-3)';
            resultRaw.innerHTML = '<div class="loading" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></div> <span style="color: var(--text-3);">Extracting text...</span>';
            resultConfidence.textContent = '';
            allProvidersEl.style.display = 'none';
            allProvidersEl.innerHTML = '';

            // currentROI is already in original image coordinates (getMousePos divides by zoomLevel)
            const actualROI = {
                x: Math.round(currentROI.x),
                y: Math.round(currentROI.y),
                width: Math.round(currentROI.width),
                height: Math.round(currentROI.height)
            };

            try {
                const res = await fetch('api/test-extraction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        camera_name: name,
                        roi: actualROI,
                        preprocessing: preprocessing
                    })
                });

                const data = await res.json();

                if (data.success) {
                    // Store extraction result for saving (with actual coordinates)
                    lastExtractionResult = {
                        cameraName: name,
                        roi: { ...actualROI },
                        roiPreview: data.roi_preview,
                        extractedValue: data.value,
                        confidence: data.confidence
                    };

                    // Update ROI preview with processed image from server (if available)
                    if (data.roi_preview) {
                        resultPreview.innerHTML = `<img src="data:image/png;base64,${data.roi_preview}" style="width: 100%; display: block;">`;
                        resultPreview.style.display = 'block';
                    }

                    // Show best result prominently
                    resultValue.textContent = data.value !== null ? data.value : '--';
                    resultRaw.textContent = `Raw: "${data.raw_text || ''}"`;

                    // Show provider and confidence for best result
                    const providerName = PROVIDER_INFO[data.selected_provider]?.name || data.selected_provider || 'Tesseract OCR';
                    resultConfidence.innerHTML = `<strong>${providerName}</strong> • ${(data.confidence || 0).toFixed(1)}% confidence`;

                    resultValue.style.color =
                        data.confidence > 50 ? 'var(--success)' :
                        data.confidence > 30 ? 'var(--warning)' : 'var(--error)';

                    // Show all provider results if multiple providers were used
                    if (data.provider_results && data.provider_results.length > 1) {
                        let allResultsHtml = '<div style="font-size: 11px; color: var(--text-3); margin-bottom: 6px; font-weight: 500;">All Provider Results:</div>';

                        data.provider_results.forEach(r => {
                            const pInfo = PROVIDER_INFO[r.provider] || { name: r.provider };
                            const isSelected = r.provider === data.selected_provider;
                            const confColor = r.confidence > 50 ? 'var(--success)' : r.confidence > 30 ? 'var(--warning)' : 'var(--error)';

                            allResultsHtml += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; margin: 2px 0; background: ${isSelected ? 'var(--primary-alpha)' : 'var(--bg)'}; border-radius: 4px; font-size: 12px;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="font-weight: ${isSelected ? '600' : '400'};">${pInfo.name}</span>
                                        ${isSelected ? '<span style="color: var(--primary); font-size: 10px;">★ BEST</span>' : ''}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="color: ${r.error ? 'var(--error)' : 'var(--text-1)'}; font-weight: 500;">${r.error ? 'Error' : (r.value !== null ? r.value : '--')}</span>
                                        <span style="color: ${confColor}; font-size: 11px;">${r.confidence ? r.confidence.toFixed(0) + '%' : ''}</span>
                                    </div>
                                </div>
                            `;
                        });

                        allProvidersEl.innerHTML = allResultsHtml;
                        allProvidersEl.style.display = 'block';
                    }

                    // Show Save ROI button on successful extraction
                    document.getElementById('add-to-roi-btn').style.display = 'flex';
                } else {
                    lastExtractionResult = null;
                    resultPreview.style.display = 'none';
                    resultValue.textContent = 'Error';
                    resultRaw.textContent = data.error || 'Unknown error';
                    resultConfidence.textContent = '';
                    allProvidersEl.style.display = 'none';
                    document.getElementById('add-to-roi-btn').style.display = 'none';
                }
            } catch (e) {
                console.error('Extraction failed:', e);
                toast('Extraction failed', 'error');
            }
        }

        async function saveExtractionROI() {
            if (!lastExtractionResult) {
                toast('No extraction result to save. Run Test Extract first.', 'error');
                return;
            }

            const { cameraName, roi, roiPreview, extractedValue } = lastExtractionResult;

            if (!roiPreview) {
                toast('No ROI image available', 'error');
                return;
            }

            // Prompt for validation value
            const validatedValue = await promptForValidationValue(extractedValue, `data:image/png;base64,${roiPreview}`);
            if (validatedValue === null && !confirm('Save ROI without validation value?')) {
                return;
            }

            try {
                const res = await fetch(`api/saved-rois/${encodeURIComponent(cameraName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        roi: roi,
                        screenshot: roiPreview,
                        extracted_value: extractedValue,
                        validated_value: validatedValue
                    })
                });

                if (res.ok) {
                    // Also save to camera config as the active ROI
                    await fetch(`api/cameras/${encodeURIComponent(cameraName)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roi_x: roi.x,
                            roi_y: roi.y,
                            roi_width: roi.width,
                            roi_height: roi.height
                        })
                    });
                    toast('ROI saved from extraction result', 'success');
                    loadSavedROIs();
                } else {
                    toast('Failed to save ROI', 'error');
                }
            } catch (e) {
                toast('Failed to save ROI', 'error');
            }
        }

        async function applyROIToCamera() {
            const name = document.getElementById('live-camera-select').value;
            if (!name) {
                toast('Please select a camera', 'error');
                return;
            }

            const cam = cameras[name];
            if (!cam) return;

            const data = {
                ...cam,
                roi_x: currentROI.x,
                roi_y: currentROI.y,
                roi_width: currentROI.width,
                roi_height: currentROI.height,
                roi_rotation: currentROI.rotation || 0,
                preprocessing: document.getElementById('live-preprocessing').value
            };

            try {
                const res = await fetch(`api/cameras/${encodeURIComponent(name)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    toast('ROI saved to camera', 'success');
                    loadCameras();
                } else {
                    toast('Failed to save ROI', 'error');
                }
            } catch (e) {
                toast('Failed to save ROI', 'error');
            }
        }

        // Saved ROIs
        async function loadSavedROIs() {
            const name = document.getElementById('live-camera-select').value;
            if (!name) return;

            const section = document.getElementById('saved-rois-section');
            const list = document.getElementById('saved-rois-list');

            try {
                const res = await fetch(`api/saved-rois/${encodeURIComponent(name)}`);
                const rois = await res.json();

                if (rois.length > 0) {
                    section.style.display = 'block';
                    const validatedCount = rois.filter(r => r.validated_value !== undefined).length;
                    list.innerHTML = rois.map(roi => {
                        const isValidated = roi.validated_value !== undefined;
                        return `
                        <div class="saved-roi-item ${isValidated ? 'validated' : ''}" data-roi-id="${roi.id}" onclick="showSavedRoiDetail('${roi.id}', ${JSON.stringify(roi).replace(/"/g, '&quot;')})">
                            <img src="api/saved-rois/${encodeURIComponent(name)}/${roi.id}/image" alt="ROI">
                            ${isValidated ? '<div class="validated-badge" title="Validated for OCR training">&#x2714;</div>' : ''}
                            <div class="saved-roi-buttons">
                                <button class="saved-roi-apply" onclick="event.stopPropagation(); applySavedROI(${JSON.stringify(roi.roi).replace(/"/g, '&quot;')})" title="Apply">&#x2714;</button>
                                <button class="saved-roi-test" onclick="testSavedROI(${JSON.stringify(roi.roi).replace(/"/g, '&quot;')}, '${roi.id}', event)" title="Test">&#x25B6;</button>
                            </div>
                            <button class="saved-roi-delete" onclick="event.stopPropagation(); deleteSavedROI('${name}', '${roi.id}')">&times;</button>
                            <div class="saved-roi-info">
                                <div class="saved-roi-value" id="roi-value-${roi.id}">
                                    <span title="Extracted value">${roi.extracted_value !== undefined && roi.extracted_value !== null ? roi.extracted_value : '--'}</span>
                                    ${isValidated ? `<span class="validated-value" title="Validated value">${roi.validated_value}</span>` : ''}
                                </div>
                                <div class="saved-roi-time">${new Date(roi.timestamp * 1000).toLocaleString()}</div>
                            </div>
                        </div>
                    `}).join('');
                } else {
                    section.style.display = 'block';
                    list.innerHTML = '<p style="color: var(--text-3); font-size: 12px;">No saved ROIs. Draw an ROI and click "Save ROI".</p>';
                }
            } catch (e) {
                console.error('Failed to load saved ROIs:', e);
            }
        }

        async function saveCurrentROI() {
            const name = document.getElementById('live-camera-select').value;
            if (!name) {
                toast('Please select a camera first', 'error');
                return;
            }

            if (currentROI.width <= 0 || currentROI.height <= 0) {
                toast('Please draw an ROI first', 'error');
                return;
            }

            // Get the current frame as base64 with ROI drawn
            const canvas = document.getElementById('preview-canvas');
            const img = document.getElementById('preview-image');

            // Create a temporary canvas to draw ROI cropped region
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');

            // currentROI is already in original image coordinates (getMousePos divides by zoomLevel)
            const roiX = Math.round(currentROI.x);
            const roiY = Math.round(currentROI.y);
            const roiW = Math.round(currentROI.width);
            const roiH = Math.round(currentROI.height);

            // Draw the ROI region
            tempCanvas.width = roiW;
            tempCanvas.height = roiH;
            ctx.drawImage(img, roiX, roiY, roiW, roiH, 0, 0, roiW, roiH);

            const screenshot = tempCanvas.toDataURL('image/png').split(',')[1];

            // Also do a test extraction to get the value
            let extractedValue = null;
            try {
                const testRes = await fetch('api/test-extraction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        camera_name: name,
                        roi: { x: roiX, y: roiY, width: roiW, height: roiH },
                        preprocessing: document.getElementById('live-preprocessing').value
                    })
                });
                const testData = await testRes.json();
                if (testData.success) {
                    extractedValue = testData.value;
                }
            } catch (e) {
                console.error('Test extraction failed:', e);
            }

            // Prompt for validation value
            const validatedValue = await promptForValidationValue(extractedValue, tempCanvas.toDataURL('image/png'));
            if (validatedValue === null && !confirm('Save ROI without validation value?')) {
                return;
            }

            try {
                const res = await fetch(`api/saved-rois/${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        roi: { x: roiX, y: roiY, width: roiW, height: roiH },
                        screenshot: screenshot,
                        extracted_value: extractedValue,
                        validated_value: validatedValue
                    })
                });

                if (res.ok) {
                    // Also save to camera config as the active ROI
                    await fetch(`api/cameras/${encodeURIComponent(name)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roi_x: roiX,
                            roi_y: roiY,
                            roi_width: roiW,
                            roi_height: roiH
                        })
                    });
                    toast('ROI saved and set as active', 'success');
                    loadSavedROIs();
                } else {
                    toast('Failed to save ROI', 'error');
                }
            } catch (e) {
                toast('Failed to save ROI', 'error');
            }
        }

        async function deleteSavedROI(cameraName, roiId) {
            if (!confirm('Delete this saved ROI?')) return;

            try {
                const res = await fetch(`api/saved-rois/${encodeURIComponent(cameraName)}/${roiId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    toast('ROI deleted', 'success');
                    loadSavedROIs();
                } else {
                    toast('Failed to delete ROI', 'error');
                }
            } catch (e) {
                toast('Failed to delete ROI', 'error');
            }
        }

        async function applySavedROI(roi) {
            // Apply the saved ROI coordinates to UI
            currentROI = {
                x: roi.x * zoomLevel,
                y: roi.y * zoomLevel,
                width: roi.width * zoomLevel,
                height: roi.height * zoomLevel
            };
            updateROIDisplay();
            drawROI();

            // Also save to camera config
            const name = document.getElementById('live-camera-select').value;
            if (name) {
                try {
                    await fetch(`api/cameras/${encodeURIComponent(name)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roi_x: roi.x,
                            roi_y: roi.y,
                            roi_width: roi.width,
                            roi_height: roi.height,
                            roi_rotation: roi.rotation || currentROI.rotation || 0
                        })
                    });
                    toast('ROI applied and saved to camera', 'success');
                } catch (e) {
                    toast('ROI applied but failed to save to camera', 'warning');
                }
            } else {
                toast('ROI applied', 'success');
            }
        }

        async function testAllROIs() {
            const name = document.getElementById('live-camera-select').value;
            if (!name) {
                toast('Please select a camera first', 'error');
                return;
            }

            const btn = document.getElementById('test-all-btn');
            btn.disabled = true;
            btn.textContent = 'Testing...';

            try {
                const res = await fetch(`api/saved-rois/${encodeURIComponent(name)}`);
                const rois = await res.json();

                if (rois.length === 0) {
                    toast('No saved ROIs to test', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Test All';
                    return;
                }

                let bestResult = null;
                let bestConfidence = 0;

                // Reset all ROI item styles before starting
                document.querySelectorAll('.saved-roi-item').forEach(el => {
                    el.style.borderColor = 'var(--border)';
                    el.classList.remove('processing');
                });

                for (let i = 0; i < rois.length; i++) {
                    const roi = rois[i];
                    const roiEl = document.querySelector(`[data-roi-id="${roi.id}"]`);
                    const valueEl = document.getElementById(`roi-value-${roi.id}`);
                    // Get only the first span (extracted value), preserve validated value span
                    const extractedSpan = valueEl ? valueEl.querySelector('span:first-child') : null;

                    // Highlight current ROI being processed
                    if (roiEl) {
                        roiEl.style.borderColor = 'var(--primary)';
                        roiEl.style.boxShadow = '0 0 8px var(--primary-alpha)';
                        roiEl.classList.add('processing');
                        roiEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }

                    btn.textContent = `Testing ${i + 1}/${rois.length}...`;

                    if (extractedSpan) {
                        extractedSpan.innerHTML = '<span class="loading" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></span>';
                    }

                    try {
                        const testRes = await fetch('api/test-extraction', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                camera_name: name,
                                roi: roi.roi,
                                preprocessing: document.getElementById('live-preprocessing').value
                            })
                        });

                        const data = await testRes.json();

                        // Reset processing style
                        if (roiEl) {
                            roiEl.style.boxShadow = '';
                            roiEl.classList.remove('processing');
                        }

                        if (extractedSpan) {
                            if (data.success) {
                                extractedSpan.textContent = data.value !== null ? data.value : '--';
                                extractedSpan.style.color = data.confidence > 50 ? 'var(--success)' : data.confidence > 30 ? 'var(--warning)' : 'var(--error)';

                                // Update border based on result quality
                                if (roiEl) {
                                    roiEl.style.borderColor = data.confidence > 50 ? 'var(--success)' : data.confidence > 30 ? 'var(--warning)' : 'var(--error)';
                                }

                                if (data.confidence > bestConfidence && data.value !== null) {
                                    bestConfidence = data.confidence;
                                    bestResult = { value: data.value, roi: roi.roi, id: roi.id };
                                }
                            } else {
                                extractedSpan.textContent = 'Error';
                                extractedSpan.style.color = 'var(--error)';
                                if (roiEl) roiEl.style.borderColor = 'var(--error)';
                            }
                        }
                    } catch (e) {
                        if (roiEl) {
                            roiEl.style.boxShadow = '';
                            roiEl.classList.remove('processing');
                            roiEl.style.borderColor = 'var(--error)';
                        }
                        if (extractedSpan) {
                            extractedSpan.textContent = 'Error';
                            extractedSpan.style.color = 'var(--error)';
                        }
                    }
                }

                if (bestResult) {
                    toast(`Best: ${bestResult.value} (${bestConfidence.toFixed(0)}% confidence)`, 'success');
                    // Highlight best ROI with star indicator
                    const bestEl = document.querySelector(`[data-roi-id="${bestResult.id}"]`);
                    if (bestEl) {
                        bestEl.style.borderColor = 'var(--success)';
                        bestEl.style.boxShadow = '0 0 12px rgba(76, 175, 80, 0.3)';
                    }
                } else {
                    toast('No valid results from any ROI', 'warning');
                }

            } catch (e) {
                toast('Test failed: ' + e.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Test All';
        }

        // Store last test results for ROI detail dialog
        let savedRoiTestResults = {};

        async function testSavedROI(roi, roiId, event) {
            if (event) event.stopPropagation();
            const name = document.getElementById('live-camera-select').value;
            if (!name) {
                toast('Please select a camera first', 'error');
                return;
            }

            // Show busy indicator on the card
            const cardEl = document.querySelector(`.saved-roi-item[data-roi-id="${roiId}"]`);
            const valueEl = document.getElementById(`roi-value-${roiId}`);

            // Save validated value span if it exists (to preserve it after test)
            const validatedSpan = valueEl ? valueEl.querySelector('.validated-value') : null;
            const validatedValue = validatedSpan ? validatedSpan.textContent : null;

            if (cardEl) {
                cardEl.style.opacity = '0.6';
                cardEl.style.pointerEvents = 'none';
            }

            // Only show loading in extracted value span, preserve validated value
            const extractedSpan = valueEl ? valueEl.querySelector('span:first-child') : null;
            if (extractedSpan) {
                extractedSpan.innerHTML = '<div class="loading" style="width: 16px; height: 16px; display: inline-block;"></div>';
            }

            try {
                const res = await fetch('api/test-extraction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        camera_name: name,
                        roi: roi,
                        preprocessing: document.getElementById('live-preprocessing').value
                    })
                });

                const data = await res.json();

                // Store result for detail dialog
                savedRoiTestResults[roiId] = {
                    ...data,
                    roi: roi,
                    timestamp: Date.now() / 1000,
                    camera_name: name
                };

                if (data.success && extractedSpan) {
                    extractedSpan.textContent = data.value !== null ? data.value : '--';
                    extractedSpan.style.color = data.confidence > 50 ? 'var(--success)' : 'var(--warning)';
                    toast(`Value: ${data.value} (${data.confidence.toFixed(0)}%)`, 'success');
                } else if (extractedSpan) {
                    extractedSpan.textContent = 'Error';
                    extractedSpan.style.color = 'var(--error)';
                }
            } catch (e) {
                if (extractedSpan) {
                    extractedSpan.textContent = 'Error';
                    extractedSpan.style.color = 'var(--error)';
                }
                toast('Test failed', 'error');
            } finally {
                // Restore card state
                if (cardEl) {
                    cardEl.style.opacity = '1';
                    cardEl.style.pointerEvents = 'auto';
                }
            }
        }

        function showSavedRoiDetail(roiId, roiData) {
            const name = document.getElementById('live-camera-select').value;
            const testResult = savedRoiTestResults[roiId] || {};
            const camera = cameras[name] || {};
            const unit = camera.unit || '';

            const time = roiData.timestamp ? new Date(roiData.timestamp * 1000).toLocaleString() : '--';
            const value = testResult.value !== undefined ? testResult.value : (roiData.extracted_value !== undefined ? roiData.extracted_value : '--');
            const confidence = testResult.confidence || roiData.confidence || 0;
            const barClass = confidence >= 80 ? 'high' : confidence >= 50 ? 'medium' : 'low';
            const rawText = testResult.raw_text || roiData.raw_text || '--';
            const validatedValue = roiData.validated_value;
            const validatedAt = roiData.validated_at ? new Date(roiData.validated_at * 1000).toLocaleString() : null;

            const dialog = document.createElement('div');
            dialog.className = 'history-detail-dialog';
            dialog.onclick = (e) => { if (e.target === dialog) dialog.remove(); };
            dialog.innerHTML = `
                <div class="history-detail-content">
                    <div class="history-detail-header">
                        <h3>Saved ROI Details</h3>
                        <button class="modal-close" onclick="this.closest('.history-detail-dialog').remove()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="history-detail-body">
                        <img class="history-detail-image" src="api/saved-rois/${encodeURIComponent(name)}/${roiId}/image" onerror="this.style.display='none'">
                        <div class="history-detail-grid">
                            <div class="history-detail-item">
                                <label>OCR Value</label>
                                <div class="value" style="color: ${confidence < 80 && confidence > 0 ? 'var(--error)' : 'var(--primary)'};">
                                    ${value} ${unit}
                                </div>
                            </div>
                            <div class="history-detail-item">
                                <label>Validated Value</label>
                                <div class="value" style="color: ${validatedValue !== undefined ? 'var(--success)' : 'var(--text-3)'};">
                                    ${validatedValue !== undefined ? validatedValue + ' ' + unit : 'Not validated'}
                                    ${validatedAt ? `<div style="font-size: 11px; color: var(--text-3);">${validatedAt}</div>` : ''}
                                </div>
                            </div>
                            <div class="history-detail-item">
                                <label>Saved On</label>
                                <div class="value">${time}</div>
                            </div>
                            <div class="history-detail-item">
                                <label>Confidence</label>
                                <div class="value">
                                    ${confidence > 0 ? confidence.toFixed(1) + '%' : '--'}
                                    ${confidence > 0 ? `<div class="confidence-bar" style="margin-top: 4px;"><div class="confidence-bar-fill ${barClass}" style="width: ${confidence}%"></div></div>` : ''}
                                </div>
                            </div>
                            <div class="history-detail-item">
                                <label>Raw Text</label>
                                <div class="value">${rawText}</div>
                            </div>
                            <div class="history-detail-item">
                                <label>ROI Coordinates</label>
                                <div class="value" style="font-family: monospace; font-size: 12px;">
                                    X: ${roiData.roi?.x || 0}, Y: ${roiData.roi?.y || 0}, W: ${roiData.roi?.width || 0}, H: ${roiData.roi?.height || 0}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="applySavedROI(${JSON.stringify(roiData.roi)}); this.closest('.history-detail-dialog').remove();">Apply ROI</button>
                            <button class="btn btn-secondary" onclick="testSavedROI(${JSON.stringify(roiData.roi)}, '${roiId}'); this.closest('.history-detail-dialog').remove();">Test Extract</button>
                            <button class="btn btn-secondary" onclick="showValidateDialog('${roiId}', ${JSON.stringify(roiData).replace(/"/g, '&quot;')})" style="background: var(--warning); color: #000;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right: 4px;">
                                    <path d="M9 11l3 3L22 4"></path>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                                </svg>
                                Validate
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        function showValidateDialog(roiId, roiData) {
            const name = document.getElementById('live-camera-select').value;
            const camera = cameras[name] || {};
            const unit = camera.unit || '';
            const currentValue = roiData.validated_value !== undefined ? roiData.validated_value : (roiData.extracted_value || '');

            // Close the detail dialog first
            document.querySelectorAll('.history-detail-dialog').forEach(d => d.remove());

            const dialog = document.createElement('div');
            dialog.className = 'history-detail-dialog';
            dialog.onclick = (e) => { if (e.target === dialog) dialog.remove(); };
            dialog.innerHTML = `
                <div class="history-detail-content" style="max-width: 400px;">
                    <div class="history-detail-header">
                        <h3>Validate OCR Value</h3>
                        <button class="modal-close" onclick="this.closest('.history-detail-dialog').remove()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="history-detail-body">
                        <img class="history-detail-image" src="api/saved-rois/${encodeURIComponent(name)}/${roiId}/image" style="max-height: 150px;" onerror="this.style.display='none'">
                        <p style="margin: 16px 0 8px; color: var(--text-2);">
                            What is the correct value shown in this image?
                        </p>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <input type="text" id="validate-value-input" class="form-control"
                                   value="${currentValue}" placeholder="Enter the correct numeric value"
                                   style="font-size: 18px; text-align: center;">
                            <small style="color: var(--text-3);">Unit: ${unit || 'none'}</small>
                        </div>
                        <p style="font-size: 12px; color: var(--text-3); margin-bottom: 16px;">
                            This helps train the OCR system to better recognize values from your camera.
                            After validating several ROIs, use "Train OCR" to find optimal settings.
                        </p>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="submitValidation('${roiId}')" style="flex: 1;">
                                Save Validated Value
                            </button>
                            <button class="btn btn-secondary" onclick="this.closest('.history-detail-dialog').remove()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);

            // Focus the input
            setTimeout(() => document.getElementById('validate-value-input').focus(), 100);
        }

        async function submitValidation(roiId) {
            const name = document.getElementById('live-camera-select').value;
            const value = document.getElementById('validate-value-input').value.trim();

            if (!value) {
                toast('Please enter a value', 'error');
                return;
            }

            try {
                const res = await fetch(`api/saved-rois/${encodeURIComponent(name)}/${encodeURIComponent(roiId)}/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: value })
                });

                if (res.ok) {
                    toast('Value validated successfully', 'success');
                    document.querySelectorAll('.history-detail-dialog').forEach(d => d.remove());
                    loadSavedROIs();
                } else {
                    const err = await res.json();
                    toast(err.error || 'Failed to validate', 'error');
                }
            } catch (e) {
                toast('Failed to validate value', 'error');
            }
        }

        async function trainOCR() {
            const name = document.getElementById('live-camera-select').value;
            if (!name) {
                toast('Please select a camera first', 'error');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading" style="width: 16px; height: 16px;"></div> Training...';

            try {
                const res = await fetch(`api/saved-rois/${encodeURIComponent(name)}/train`, {
                    method: 'POST'
                });

                const data = await res.json();

                if (data.error) {
                    toast(data.error, 'error');
                } else {
                    // Show training results
                    showTrainingResults(data);
                }
            } catch (e) {
                toast('Training failed: ' + e.message, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right: 4px;">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg> Train OCR`;
        }

        function showTrainingResults(data) {
            const dialog = document.createElement('div');
            dialog.className = 'history-detail-dialog';
            dialog.onclick = (e) => { if (e.target === dialog) dialog.remove(); };

            const best = data.best_config || {};
            const ranked = data.ranked_configs || [];

            dialog.innerHTML = `
                <div class="history-detail-content" style="max-width: 500px;">
                    <div class="history-detail-header">
                        <h3>OCR Training Results</h3>
                        <button class="modal-close" onclick="this.closest('.history-detail-dialog').remove()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="history-detail-body">
                        <div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 8px; color: var(--success);">Best Configuration</h4>
                            <p style="margin: 4px 0; font-size: 14px;">
                                <strong>Preprocessing:</strong> ${best.preprocessing || 'auto'}<br>
                                <strong>PSM Mode:</strong> ${best.psm || 7}<br>
                                <strong>Accuracy:</strong> ${(best.accuracy || 0).toFixed(1)}% (${best.matches || 0}/${best.total || 0} matches)
                            </p>
                        </div>

                        <p style="margin: 0 0 8px; font-weight: 600;">Tested on ${data.tested_count || 0} of ${data.validated_count || 0} validated ROI(s)</p>
                        ${data.tested_rois && data.tested_rois.length > 0 ? `
                        <div style="background: var(--bg); padding: 8px; border-radius: 4px; font-size: 12px; margin-bottom: 12px;">
                            <strong>ROIs used:</strong>
                            <ul style="margin: 4px 0 0 16px; padding: 0;">
                                ${data.tested_rois.map(r => `<li>${r.id} (expected: ${r.expected})</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        <div style="margin-top: 16px;">
                            <h4 style="margin: 0 0 8px;">Top Configurations</h4>
                            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg);">
                                        <th style="padding: 8px; text-align: left;">Preprocessing</th>
                                        <th style="padding: 8px; text-align: center;">PSM</th>
                                        <th style="padding: 8px; text-align: right;">Accuracy</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ranked.map((cfg, i) => `
                                        <tr style="${i === 0 ? 'background: rgba(76, 175, 80, 0.1);' : ''}">
                                            <td style="padding: 8px;">${cfg.preprocessing}</td>
                                            <td style="padding: 8px; text-align: center;">${cfg.psm}</td>
                                            <td style="padding: 8px; text-align: right;">${(cfg.matches / cfg.total * 100).toFixed(1)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <p style="font-size: 12px; color: var(--text-3); margin-top: 16px;">
                            To use the best configuration, set the camera's preprocessing to "${best.preprocessing || 'auto'}".
                        </p>

                        <div style="margin-top: 16px;">
                            <button class="btn btn-primary" onclick="this.closest('.history-detail-dialog').remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        // Templates
        async function saveTemplate() {
            const name = document.getElementById('live-camera-select').value;
            const templateName = document.getElementById('template-name-input').value.trim();

            if (!name || !templateName) {
                toast('Please select a camera and enter a template name', 'error');
                return;
            }

            if (currentROI.width <= 0 || currentROI.height <= 0) {
                toast('Please draw an ROI first', 'error');
                return;
            }

            try {
                const res = await fetch('api/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        camera_name: name,
                        template_name: templateName,
                        roi: currentROI
                    })
                });

                if (res.ok) {
                    toast('Template saved', 'success');
                    document.getElementById('template-name-input').value = '';
                    loadTemplates();
                } else {
                    const err = await res.json();
                    toast(err.error || 'Failed to save template', 'error');
                }
            } catch (e) {
                toast('Failed to save template', 'error');
            }
        }

        async function deleteTemplate(name) {
            if (!confirm(`Delete template "${name}"?`)) return;

            try {
                const res = await fetch(`api/templates/${encodeURIComponent(name)}`, { method: 'DELETE' });
                if (res.ok) {
                    toast('Template deleted', 'success');
                    loadTemplates();
                }
            } catch (e) {
                toast('Failed to delete template', 'error');
            }
        }

        // Discovery
        async function startDiscovery() {
            const btn = document.getElementById('discover-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div> Scanning...';

            const list = document.getElementById('discovery-list');
            list.innerHTML = '<div class="empty-state"><div class="loading"></div><p style="margin-top: 16px;">Scanning network for cameras...</p></div>';

            try {
                const res = await fetch('api/discover', { method: 'POST' });
                const discovered = await res.json();

                if (discovered.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <h3>No cameras found</h3>
                            <p>No cameras were discovered on your network.<br>Check that cameras are powered on and connected.</p>
                        </div>
                    `;
                } else {
                    list.innerHTML = discovered.map((cam, idx) => {
                        const safeName = (cam.name || cam.ip).replace(/'/g, "\\'");
                        const safeMfr = (cam.manufacturer || '').replace(/'/g, "\\'");
                        const onvifInfo = cam.onvif_port ? ` • ONVIF:${cam.onvif_port}` : '';
                        return `
                        <div class="discovery-item" id="discovery-${idx}">
                            <div class="discovery-item-header">
                                <div class="discovery-item-info">
                                    <h4>${cam.name || cam.ip}</h4>
                                    <p>${cam.manufacturer ? cam.manufacturer + ' • ' : ''}${cam.ip}:${cam.port}${onvifInfo}</p>
                                </div>
                            </div>
                            <div class="discovery-item-preview" id="discovery-preview-${idx}">
                                <div class="preview-placeholder">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                        <circle cx="12" cy="13" r="4"></circle>
                                    </svg>
                                    <div class="loading" style="margin-top: 8px;"></div>
                                    <p style="margin-top: 8px;">Loading preview...</p>
                                </div>
                            </div>
                            <div class="discovery-item-actions">
                                <button class="btn btn-secondary btn-sm" onclick="previewDiscoveredCamera(${idx}, '${cam.ip}', ${cam.port}, '${cam.stream_url}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    Preview
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="addDiscoveredCamera('${cam.ip}', ${cam.port}, '${cam.stream_url}', '${safeMfr}', '${safeName}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Add
                                </button>
                            </div>
                        </div>`;
                    }).join('');

                    // Auto-load previews for discovered cameras
                    discovered.forEach((cam, idx) => {
                        loadDiscoveryPreview(idx, cam.ip, cam.port, cam.stream_url);
                    });
                }
            } catch (e) {
                list.innerHTML = '<div class="empty-state"><p style="color: var(--error);">Discovery failed</p></div>';
            }

            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                Scan Network
            `;
        }

        async function loadDiscoveryPreview(idx, ip, port, streamUrl) {
            const previewEl = document.getElementById(`discovery-preview-${idx}`);
            if (!previewEl) return;

            try {
                // Try to capture a frame using the test endpoint
                const testUrl = streamUrl.replace('{user}', 'admin').replace('{pass}', 'admin');
                const res = await fetch('api/test-capture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: testUrl, username: '', password: '' })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.frame) {
                        previewEl.innerHTML = `<img src="data:image/png;base64,${data.frame}" alt="Preview">`;
                        return;
                    }
                }
                previewEl.innerHTML = `<div class="preview-error">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <span>Credentials required</span>
                    <small>Add camera and configure username/password</small>
                </div>`;
            } catch (e) {
                previewEl.innerHTML = `<div class="preview-error">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <span>Credentials required</span>
                    <small>Add camera and configure username/password</small>
                </div>`;
            }
        }

        function previewDiscoveredCamera(idx, ip, port, streamUrl) {
            const previewEl = document.getElementById(`discovery-preview-${idx}`);
            if (!previewEl) return;

            previewEl.innerHTML = '<div class="preview-placeholder"><div class="loading"></div><p style="margin-top: 8px;">Loading preview...</p></div>';
            loadDiscoveryPreview(idx, ip, port, streamUrl);
        }

        function addDiscoveredCamera(ip, port, streamUrl, manufacturer, name) {
            // Open the modal first
            openAddCameraModal();
            document.getElementById('camera-modal-title').textContent = 'Add Discovered Camera';

            // Set camera name
            const cameraName = name || (manufacturer ? `${manufacturer} ${ip}` : `Camera ${ip}`);
            document.getElementById('camera-name').value = cameraName;

            // Set the full URL with placeholder credentials
            const fullUrl = streamUrl.replace('{user}', 'admin').replace('{pass}', 'admin');
            document.getElementById('camera-url').value = fullUrl;

            // Parse URL to populate builder fields
            parseUrlToFields();

            // Clear password since it's just a placeholder
            document.getElementById('camera-password').value = '';

            // Set default port if not in URL
            if (!document.getElementById('camera-port').value) {
                document.getElementById('camera-port').value = port || '554';
            }
        }

        // Utilities
        function updateStatus() {
            const count = Object.keys(cameras).length;
            document.getElementById('camera-count').textContent = `${count} camera${count !== 1 ? 's' : ''}`;
        }

        function toast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    ${type === 'success' ? '<polyline points="20 6 9 17 4 12"></polyline>' :
                      type === 'error' ? '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>' :
                      '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>'}
                </svg>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 200);
            }, 3000);
        }

        // AI/OCR Multi-Provider Settings
        const PROVIDER_INFO = {
            'tesseract': { name: 'Tesseract OCR', needsKey: false, needsUrl: false, local: true },
            'easyocr': { name: 'EasyOCR', needsKey: false, needsUrl: false, local: true },
            'paddleocr': { name: 'PaddleOCR', needsKey: false, needsUrl: false, local: true },
            'ml': { name: 'ML (TrOCR)', needsKey: false, needsUrl: false, local: true },
            'openai': { name: 'OpenAI (GPT-4o)', needsKey: true, needsUrl: false, local: false },
            'anthropic': { name: 'Anthropic (Claude)', needsKey: true, needsUrl: false, local: false },
            'google': { name: 'Google (Gemini)', needsKey: true, needsUrl: false, local: false },
            'ollama': { name: 'Ollama (Local)', needsKey: false, needsUrl: true, local: true },
            'custom': { name: 'Custom API', needsKey: true, needsUrl: true, local: false },
            'google-vision': { name: 'Google Cloud Vision', needsKey: true, needsUrl: false, local: false },
            'azure-ocr': { name: 'Azure Computer Vision', needsKey: true, needsUrl: true, local: false },
            'aws-textract': { name: 'AWS Textract', needsKey: true, needsUrl: false, needsRegion: true, local: false }
        };

        let currentProviders = [];
        let providerConfigs = {};
        let editingProvider = null;
        let mlStatus = { available: false };

        // OCR Config Modal Functions
        let ocrConfigCameraName = '';
        let ocrCurrentProviders = [];
        let ocrProviderConfigs = {};
        let ocrEditingProvider = null;

        function openOCRConfigModal() {
            const cameraName = document.getElementById('live-camera-select').value;
            if (!cameraName) {
                toast('Please select a camera first', 'error');
                return;
            }

            ocrConfigCameraName = cameraName;
            document.getElementById('ocr-config-camera-name').textContent = cameraName;

            // Load camera's OCR config - use deep copies to avoid reference issues
            const camera = cameras[cameraName];
            if (camera) {
                // Deep copy arrays and objects to prevent modifying original
                ocrCurrentProviders = Array.isArray(camera.ocr_providers) && camera.ocr_providers.length > 0
                    ? [...camera.ocr_providers]
                    : ['tesseract'];
                ocrProviderConfigs = camera.provider_configs
                    ? JSON.parse(JSON.stringify(camera.provider_configs))
                    : {};
                document.getElementById('ocr-use-ml-roi-locator').checked = camera.use_ml_roi_locator || false;
                document.getElementById('ocr-enable-description').checked = camera.ai_enabled_for_description || false;

                console.log('OCR Config Modal opened for', cameraName, {
                    ocr_providers: ocrCurrentProviders,
                    provider_configs_keys: Object.keys(ocrProviderConfigs)
                });
            } else {
                ocrCurrentProviders = ['tesseract'];
                ocrProviderConfigs = {};
            }

            renderOCRProviderList();
            document.getElementById('ocr-config-modal').classList.add('active');
        }

        function closeOCRConfigModal() {
            document.getElementById('ocr-config-modal').classList.remove('active');
            document.getElementById('ocr-provider-config-panel').style.display = 'none';
        }

        function renderOCRProviderList() {
            const list = document.getElementById('ocr-provider-list');
            if (ocrCurrentProviders.length === 0) {
                list.innerHTML = '<p style="color: var(--text-3); font-size: 13px;">No providers configured. Add at least one.</p>';
                return;
            }

            list.innerHTML = ocrCurrentProviders.map((provider, index) => {
                const info = PROVIDER_INFO[provider] || { name: provider, needsKey: false };
                const config = ocrProviderConfigs[provider] || {};
                // Check if configured: either has_api_key flag, or has an api_key (even if masked), or doesn't need a key
                const isConfigured = !info.needsKey || config.has_api_key || (config.api_key && config.api_key.length > 0);
                const statusClass = isConfigured ? 'configured' : 'needs-config';
                const statusText = isConfigured ? '✓ Ready' : '⚠ Needs config';

                return `
                    <div class="provider-item" draggable="true" data-provider="${provider}" data-index="${index}">
                        <span class="drag-handle">☰</span>
                        <span class="provider-name">${info.name}</span>
                        <span class="provider-status ${statusClass}">${statusText}</span>
                        <div class="provider-actions">
                            ${info.needsKey || info.needsUrl ? `<button class="provider-btn" onclick="configureOCRProvider('${provider}')">Configure</button>` : ''}
                            <button class="provider-btn remove" onclick="removeOCRProvider(${index})">×</button>
                        </div>
                    </div>
                `;
            }).join('');

            setupOCRProviderDragDrop();
        }

        function setupOCRProviderDragDrop() {
            const items = document.querySelectorAll('#ocr-provider-list .provider-item');
            items.forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                    item.classList.add('dragging');
                });
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
                item.addEventListener('dragover', e => e.preventDefault());
                item.addEventListener('drop', e => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = parseInt(item.dataset.index);
                    if (fromIndex !== toIndex) {
                        const [moved] = ocrCurrentProviders.splice(fromIndex, 1);
                        ocrCurrentProviders.splice(toIndex, 0, moved);
                        renderOCRProviderList();
                    }
                });
            });
        }

        function showAddProviderDialogModal() {
            const availableProviders = Object.entries(PROVIDER_INFO)
                .filter(([key]) => !ocrCurrentProviders.includes(key))
                .map(([key, info]) => `<option value="${key}">${info.name}${info.local ? ' (Local)' : ''}</option>`)
                .join('');

            if (!availableProviders) {
                toast('All providers already added', 'info');
                return;
            }

            const html = `
                <div class="form-group">
                    <label class="form-label">Select Provider</label>
                    <select id="ocr-new-provider-select" class="form-input">
                        <option value="">-- Select --</option>
                        ${availableProviders}
                    </select>
                </div>
                <button class="btn btn-primary btn-sm" onclick="addOCRSelectedProvider()">Add Provider</button>
            `;

            document.getElementById('ocr-config-panel-title').textContent = 'Add Provider';
            document.getElementById('ocr-provider-config-fields').innerHTML = html;
            document.getElementById('ocr-provider-config-panel').style.display = 'block';
            ocrEditingProvider = null;
        }

        function addOCRSelectedProvider() {
            const provider = document.getElementById('ocr-new-provider-select').value;
            if (!provider) {
                toast('Please select a provider', 'error');
                return;
            }

            ocrCurrentProviders.push(provider);
            ocrProviderConfigs[provider] = ocrProviderConfigs[provider] || {};
            renderOCRProviderList();
            closeOCRProviderConfig();

            const info = PROVIDER_INFO[provider];
            if (info && (info.needsKey || info.needsUrl)) {
                configureOCRProvider(provider);
            }
        }

        function removeOCRProvider(index) {
            ocrCurrentProviders.splice(index, 1);
            renderOCRProviderList();
        }

        function configureOCRProvider(provider) {
            const info = PROVIDER_INFO[provider] || {};
            const config = ocrProviderConfigs[provider] || {};
            ocrEditingProvider = provider;

            // Check if API key is masked (already configured)
            const hasExistingKey = config.has_api_key || (config.api_key && config.api_key.includes('•'));

            let html = '';
            if (info.needsKey) {
                html += `
                    <div class="form-group">
                        <label class="form-label">API Key ${hasExistingKey ? '<span style="color: var(--success); font-size: 11px;">(configured)</span>' : ''}</label>
                        <input type="password" id="ocr-provider-api-key" class="form-input" value="" placeholder="${hasExistingKey ? 'Leave empty to keep existing key' : 'Enter API key'}">
                        ${hasExistingKey ? '<small style="color: var(--text-3);">A key is already configured. Enter a new key to replace it, or leave empty to keep the existing one.</small>' : ''}
                    </div>
                `;
            }
            if (info.needsUrl) {
                html += `
                    <div class="form-group">
                        <label class="form-label">API URL / Endpoint</label>
                        <input type="text" id="ocr-provider-api-url" class="form-input" value="${config.api_url || ''}" placeholder="e.g., http://localhost:11434">
                    </div>
                `;
            }
            if (info.needsRegion) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Region</label>
                        <input type="text" id="ocr-provider-region" class="form-input" value="${config.region || ''}" placeholder="e.g., us-east-1">
                    </div>
                `;
            }
            if (!info.local) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Model (optional)</label>
                        <input type="text" id="ocr-provider-model" class="form-input" value="${config.model || ''}" placeholder="Leave empty for default">
                    </div>
                `;
            }

            document.getElementById('ocr-config-panel-title').textContent = `Configure ${info.name || provider}`;
            document.getElementById('ocr-provider-config-fields').innerHTML = html;
            document.getElementById('ocr-provider-config-panel').style.display = 'block';
        }

        function closeOCRProviderConfig() {
            document.getElementById('ocr-provider-config-panel').style.display = 'none';
            ocrEditingProvider = null;
        }

        function saveOCRProviderConfig() {
            if (!ocrEditingProvider) return;

            const info = PROVIDER_INFO[ocrEditingProvider] || {};
            const config = ocrProviderConfigs[ocrEditingProvider] || {};

            if (info.needsKey) {
                const newApiKey = document.getElementById('ocr-provider-api-key')?.value || '';
                // Only update api_key if user entered a new value (not empty)
                // If empty, preserve existing key on server side
                if (newApiKey) {
                    config.api_key = newApiKey;
                }
                // Keep has_api_key flag if it was set and no new key provided
                // This tells the UI the key is configured even if we don't have the actual value
                if (!newApiKey && config.has_api_key) {
                    // Key is already configured on server, UI will show "configured"
                } else if (newApiKey) {
                    config.has_api_key = true;
                }
            }
            if (info.needsUrl) {
                config.api_url = document.getElementById('ocr-provider-api-url')?.value || '';
            }
            if (info.needsRegion) {
                config.region = document.getElementById('ocr-provider-region')?.value || '';
            }
            if (!info.local) {
                config.model = document.getElementById('ocr-provider-model')?.value || '';
            }

            ocrProviderConfigs[ocrEditingProvider] = config;
            renderOCRProviderList();
            closeOCRProviderConfig();
            toast('Provider settings saved locally - click Save Configuration to persist', 'info');
        }

        async function saveOCRConfig() {
            if (!ocrConfigCameraName) {
                toast('No camera selected', 'error');
                return;
            }

            try {
                const updateData = {
                    ocr_providers: ocrCurrentProviders,
                    provider_configs: ocrProviderConfigs,
                    use_ml_roi_locator: document.getElementById('ocr-use-ml-roi-locator').checked,
                    ai_enabled_for_description: document.getElementById('ocr-enable-description').checked
                };

                console.log('Saving OCR config for', ocrConfigCameraName, {
                    ocr_providers: updateData.ocr_providers,
                    provider_configs_keys: Object.keys(updateData.provider_configs),
                    use_ml_roi_locator: updateData.use_ml_roi_locator,
                    ai_enabled_for_description: updateData.ai_enabled_for_description
                });

                const res = await fetch(`api/cameras/${encodeURIComponent(ocrConfigCameraName)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (res.ok) {
                    const result = await res.json();
                    console.log('OCR config save response:', result);

                    // Update local cache with deep copies
                    if (cameras[ocrConfigCameraName]) {
                        cameras[ocrConfigCameraName].ocr_providers = [...ocrCurrentProviders];
                        cameras[ocrConfigCameraName].provider_configs = JSON.parse(JSON.stringify(ocrProviderConfigs));
                        cameras[ocrConfigCameraName].use_ml_roi_locator = updateData.use_ml_roi_locator;
                        cameras[ocrConfigCameraName].ai_enabled_for_description = updateData.ai_enabled_for_description;
                    }
                    toast('OCR configuration saved', 'success');
                    closeOCRConfigModal();
                } else {
                    const err = await res.json();
                    console.error('OCR config save failed:', err);
                    toast(err.error || 'Failed to save configuration', 'error');
                }
            } catch (e) {
                console.error('OCR config save exception:', e);
                toast('Failed to save configuration', 'error');
            }
        }

        async function loadAIConfig() {
            // Load ML status
            try {
                const res = await fetch('api/ml/status');
                mlStatus = await res.json();
                const badge = document.getElementById('ml-status-badge');
                if (mlStatus.available) {
                    badge.textContent = 'ML: Available';
                    badge.className = 'ml-status-badge available';
                } else {
                    badge.textContent = 'ML: Not Available';
                    badge.className = 'ml-status-badge unavailable';
                }
            } catch (e) {
                mlStatus = { available: false };
            }

            // Populate camera selector
            const select = document.getElementById('ai-camera-select');
            select.innerHTML = '<option value="">-- Select Camera --</option>';
            for (const [name, camera] of Object.entries(cameras)) {
                select.innerHTML += `<option value="${name}">${name}</option>`;
            }
            document.getElementById('ai-camera-config').style.display = 'none';
        }

        async function onAICameraChange() {
            const cameraName = document.getElementById('ai-camera-select').value;
            const configSection = document.getElementById('ai-camera-config');
            const testSection = document.getElementById('ai-test-section');

            if (!cameraName) {
                configSection.style.display = 'none';
                testSection.style.display = 'none';
                return;
            }

            configSection.style.display = 'block';
            testSection.style.display = 'block';

            // Load camera's provider config
            const camera = cameras[cameraName];
            if (camera) {
                currentProviders = camera.ocr_providers || ['tesseract'];
                providerConfigs = camera.provider_configs || {};
                document.getElementById('use-ml-roi-locator').checked = camera.use_ml_roi_locator || false;
                document.getElementById('ai-enable-description').checked = camera.ai_enabled_for_description || false;

                // Migrate legacy single provider if needed
                if (currentProviders.length === 0 && camera.ai_provider && camera.ai_provider !== 'none') {
                    currentProviders = ['tesseract', camera.ai_provider];
                    providerConfigs[camera.ai_provider] = {
                        api_key: camera.ai_api_key,
                        api_url: camera.ai_api_url,
                        model: camera.ai_model,
                        region: camera.ai_region
                    };
                }

                renderProviderList();
            }
        }

        function renderProviderList() {
            const list = document.getElementById('provider-list');
            if (currentProviders.length === 0) {
                list.innerHTML = '<p style="color: var(--text-3); font-size: 13px;">No providers configured. Add at least one provider.</p>';
                return;
            }

            list.innerHTML = currentProviders.map((provider, index) => {
                const info = PROVIDER_INFO[provider] || { name: provider, needsKey: false };
                const config = providerConfigs[provider] || {};
                const isConfigured = !info.needsKey || config.api_key;
                const statusClass = isConfigured ? 'configured' : 'needs-config';
                const statusText = isConfigured ? '✓ Ready' : '⚠ Needs config';

                return `
                    <div class="provider-item" draggable="true" data-provider="${provider}" data-index="${index}">
                        <span class="drag-handle">☰</span>
                        <span class="provider-name">${info.name}</span>
                        <span class="provider-status ${statusClass}">${statusText}</span>
                        <div class="provider-actions">
                            ${info.needsKey || info.needsUrl ? `<button class="provider-btn" onclick="configureProvider('${provider}')">Configure</button>` : ''}
                            <button class="provider-btn remove" onclick="removeProvider(${index})">×</button>
                        </div>
                    </div>
                `;
            }).join('');

            // Add drag-and-drop handlers
            setupProviderDragDrop();
        }

        function setupProviderDragDrop() {
            const items = document.querySelectorAll('.provider-item');
            items.forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                    item.classList.add('dragging');
                });
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
                item.addEventListener('dragover', e => e.preventDefault());
                item.addEventListener('drop', e => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = parseInt(item.dataset.index);
                    if (fromIndex !== toIndex) {
                        const [moved] = currentProviders.splice(fromIndex, 1);
                        currentProviders.splice(toIndex, 0, moved);
                        renderProviderList();
                    }
                });
            });
        }

        function showAddProviderDialog() {
            const availableProviders = Object.entries(PROVIDER_INFO)
                .filter(([key]) => !currentProviders.includes(key))
                .map(([key, info]) => `<option value="${key}">${info.name}${info.local ? ' (Local)' : ''}</option>`)
                .join('');

            if (!availableProviders) {
                toast('All providers already added', 'info');
                return;
            }

            const html = `
                <div class="form-group">
                    <label class="form-label">Select Provider</label>
                    <select id="new-provider-select" class="form-input">
                        <option value="">-- Select --</option>
                        ${availableProviders}
                    </select>
                </div>
                <button class="btn btn-primary btn-sm" onclick="addSelectedProvider()">Add Provider</button>
            `;

            document.getElementById('config-panel-title').textContent = 'Add Provider';
            document.getElementById('provider-config-fields').innerHTML = html;
            document.getElementById('provider-config-panel').style.display = 'block';
            editingProvider = null;
        }

        function addSelectedProvider() {
            const provider = document.getElementById('new-provider-select').value;
            if (!provider) {
                toast('Please select a provider', 'error');
                return;
            }

            currentProviders.push(provider);
            providerConfigs[provider] = providerConfigs[provider] || {};
            renderProviderList();
            closeProviderConfig();

            const info = PROVIDER_INFO[provider];
            if (info.needsKey || info.needsUrl) {
                configureProvider(provider);
            }
        }

        function removeProvider(index) {
            currentProviders.splice(index, 1);
            renderProviderList();
        }

        function configureProvider(provider) {
            const info = PROVIDER_INFO[provider] || {};
            const config = providerConfigs[provider] || {};
            editingProvider = provider;

            let html = '';

            if (info.needsKey) {
                html += `
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" id="provider-api-key" class="form-input"
                            value="${config.api_key || ''}"
                            placeholder="${config.api_key ? '••••••••••••••••' : 'Enter API key'}">
                    </div>
                `;
            }

            if (info.needsUrl) {
                const urlLabel = provider === 'azure-ocr' ? 'Endpoint URL' : 'API URL';
                const placeholder = provider === 'ollama' ? 'http://localhost:11434' : 'https://api.example.com';
                html += `
                    <div class="form-group">
                        <label class="form-label">${urlLabel}</label>
                        <input type="text" id="provider-api-url" class="form-input"
                            value="${config.api_url || ''}" placeholder="${placeholder}">
                    </div>
                `;
            }

            if (info.needsRegion) {
                html += `
                    <div class="form-group">
                        <label class="form-label">AWS Region</label>
                        <input type="text" id="provider-region" class="form-input"
                            value="${config.region || ''}" placeholder="us-east-1">
                    </div>
                `;
            }

            if (['openai', 'anthropic', 'google', 'ollama', 'custom'].includes(provider)) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Model (optional)</label>
                        <input type="text" id="provider-model" class="form-input"
                            value="${config.model || ''}" placeholder="Leave empty for default">
                    </div>
                `;
            }

            document.getElementById('config-panel-title').textContent = `Configure ${info.name}`;
            document.getElementById('provider-config-fields').innerHTML = html;
            document.getElementById('provider-config-panel').style.display = 'block';
        }

        function saveProviderConfig() {
            if (!editingProvider) return;

            const config = {};
            const apiKey = document.getElementById('provider-api-key');
            const apiUrl = document.getElementById('provider-api-url');
            const region = document.getElementById('provider-region');
            const model = document.getElementById('provider-model');

            if (apiKey && apiKey.value) config.api_key = apiKey.value;
            if (apiUrl) config.api_url = apiUrl.value;
            if (region) config.region = region.value;
            if (model) config.model = model.value;

            providerConfigs[editingProvider] = { ...(providerConfigs[editingProvider] || {}), ...config };
            renderProviderList();
            closeProviderConfig();
            toast('Provider configured', 'success');
        }

        function closeProviderConfig() {
            document.getElementById('provider-config-panel').style.display = 'none';
            editingProvider = null;
        }

        async function saveMultiProviderConfig() {
            const cameraName = document.getElementById('ai-camera-select').value;
            if (!cameraName) {
                toast('Please select a camera first', 'error');
                return;
            }

            if (currentProviders.length === 0) {
                toast('Please add at least one provider', 'error');
                return;
            }

            try {
                const updateData = {
                    ocr_providers: currentProviders,
                    provider_configs: providerConfigs,
                    use_ml_roi_locator: document.getElementById('use-ml-roi-locator').checked,
                    ai_enabled_for_description: document.getElementById('ai-enable-description').checked
                };

                const res = await fetch(`api/cameras/${encodeURIComponent(cameraName)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (res.ok) {
                    toast('Configuration saved for ' + cameraName, 'success');
                    await loadCameras();
                } else {
                    toast('Failed to save configuration', 'error');
                }
            } catch (e) {
                toast('Error: ' + e.message, 'error');
            }
        }

        let aiTestImageBase64 = null;

        function onAITestSourceChange() {
            const source = document.getElementById('ai-test-source').value;
            document.getElementById('ai-test-upload-section').style.display = source === 'upload' ? 'block' : 'none';
            document.getElementById('ai-test-camera-section').style.display = source === 'camera' ? 'block' : 'none';
            aiTestImageBase64 = null;

            if (source === 'camera') {
                const select = document.getElementById('ai-test-camera');
                const cameraNames = Object.keys(cameras);
                select.innerHTML = '<option value="">-- Select Camera --</option>' +
                    cameraNames.map(name => `<option value="${name}">${name}</option>`).join('');
            }
        }

        function onAITestFileSelect() {
            const file = document.getElementById('ai-test-file').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                aiTestImageBase64 = e.target.result.split(',')[1];
                document.getElementById('ai-test-preview-img').src = e.target.result;
                document.getElementById('ai-test-preview-upload').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function onAITestCameraChange() {
            const cameraName = document.getElementById('ai-test-camera').value;
            if (!cameraName) {
                document.getElementById('ai-test-preview-camera').style.display = 'none';
                aiTestImageBase64 = null;
                return;
            }

            try {
                const res = await fetch(`api/preview/${encodeURIComponent(cameraName)}?roi=true`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.frame) {
                        aiTestImageBase64 = data.roi_frame || data.frame;
                        document.getElementById('ai-test-camera-img').src = 'data:image/png;base64,' + data.frame;
                        document.getElementById('ai-test-preview-camera').style.display = 'block';
                    }
                }
            } catch (e) {
                toast('Failed to load camera preview', 'error');
            }
        }

        async function testAllProviders() {
            const testBtn = document.getElementById('test-ai-btn');
            const resultsCard = document.getElementById('ai-test-results');
            const resultsContent = document.getElementById('ai-test-content');
            const cameraName = document.getElementById('ai-camera-select').value;

            const source = document.getElementById('ai-test-source').value;
            let imageBase64 = aiTestImageBase64;
            let testCamera = null;

            if (source === 'camera') {
                testCamera = document.getElementById('ai-test-camera').value;
                if (!testCamera) {
                    toast('Please select a camera', 'error');
                    return;
                }
            } else if (!imageBase64) {
                toast('Please select an image first', 'error');
                return;
            }

            if (currentProviders.length === 0) {
                toast('No providers configured', 'error');
                return;
            }

            testBtn.disabled = true;
            testBtn.innerHTML = '<div class="loading" style="width: 16px; height: 16px;"></div> Testing...';
            resultsCard.style.display = 'block';
            resultsContent.innerHTML = '<div class="loading"></div><p style="text-align: center; margin-top: 12px;">Testing all providers...</p>';

            // Capture image from camera if needed
            let testImageBase64 = imageBase64;
            if (source === 'camera' && testCamera) {
                try {
                    const captureRes = await fetch(`api/capture/${encodeURIComponent(testCamera)}`);
                    const captureData = await captureRes.json();
                    if (captureData.image) {
                        testImageBase64 = captureData.image;
                    } else {
                        toast('Failed to capture from camera', 'error');
                        testBtn.disabled = false;
                        testBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Test All Providers`;
                        return;
                    }
                } catch (e) {
                    toast('Failed to capture from camera: ' + e.message, 'error');
                    testBtn.disabled = false;
                    testBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Test All Providers`;
                    return;
                }
            }

            // Test each provider
            const results = [];
            for (const provider of currentProviders) {
                try {
                    let result;
                    if (provider === 'tesseract') {
                        // Test via extraction endpoint
                        const res = await fetch('api/test-extraction', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ camera_name: testCamera || cameraName, image: testImageBase64 })
                        });
                        const data = await res.json();
                        result = { provider, value: data.value, confidence: data.confidence, error: data.error };
                    } else if (provider === 'ml') {
                        const res = await fetch('api/ml/test', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: testImageBase64, camera_name: testCamera || cameraName })
                        });
                        const data = await res.json();
                        result = { provider, value: data.value, confidence: data.confidence, error: data.error };
                    } else {
                        // AI provider test
                        const config = providerConfigs[provider] || {};
                        const res = await fetch('api/ai-test', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                image: testImageBase64,
                                camera: testCamera || cameraName,
                                provider: provider,
                                api_key: config.api_key,
                                api_url: config.api_url,
                                model: config.model,
                                region: config.region,
                                enable_ocr: true
                            })
                        });
                        const data = await res.json();
                        result = { provider, value: data.ocr, confidence: 85, error: data.error };
                    }
                    results.push(result);
                } catch (e) {
                    results.push({ provider, error: e.message, confidence: 0 });
                }
            }

            // Find best result
            const bestResult = results.reduce((best, r) =>
                r.value && r.confidence > (best?.confidence || 0) ? r : best, null);

            // Render results with input image thumbnail
            let html = '';
            if (testImageBase64) {
                html += `
                    <div style="display: flex; gap: 16px; margin-bottom: 16px; align-items: flex-start;">
                        <div style="flex-shrink: 0;">
                            <div style="font-size: 12px; color: var(--text-2); margin-bottom: 4px;">Input Image</div>
                            <img src="data:image/jpeg;base64,${testImageBase64}" style="max-width: 150px; max-height: 100px; border-radius: 4px; border: 1px solid var(--border);">
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: var(--text-2); margin-bottom: 4px;">Best Result</div>
                            <div style="font-size: 24px; font-weight: 600; color: var(--primary);">${bestResult?.value || '--'}</div>
                            <div style="font-size: 12px; color: var(--text-2);">${bestResult ? PROVIDER_INFO[bestResult.provider]?.name || bestResult.provider : 'No valid result'}</div>
                        </div>
                    </div>
                `;
            }
            html += '<div class="provider-results-list">';
            for (const r of results) {
                const info = PROVIDER_INFO[r.provider] || { name: r.provider };
                const isSelected = bestResult && r.provider === bestResult.provider;
                html += `
                    <div class="provider-result-item ${isSelected ? 'selected' : ''}">
                        <div>
                            <div class="result-provider">${info.name} ${isSelected ? '✓ Best' : ''}</div>
                            <div class="result-confidence">${r.confidence ? r.confidence.toFixed(0) + '% confidence' : ''}</div>
                        </div>
                        <div class="result-value" style="color: ${r.error ? 'var(--error)' : 'var(--text-1)'}">
                            ${r.error || r.value || '--'}
                        </div>
                    </div>
                `;
            }
            html += '</div>';

            resultsContent.innerHTML = html;
            testBtn.disabled = false;
            testBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg> Test All Providers`;
            toast('Test completed', 'success');
        }

    </script>
</body>
</html>
